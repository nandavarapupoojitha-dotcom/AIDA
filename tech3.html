<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIDA - AI Virtual Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            /* Light Theme Variables */
            --bg-body: #f8f9fa;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-chat: #f1f3f5;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent: #4361ee; /* Modern Blue */
            --accent-hover: #3f37c9;
            --msg-user: #4361ee;
            --msg-bot: #e9ecef;
            --border: #dee2e6;
            --shadow: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --success: #06ffa5;
            --warning: #ffbe0b;
            --danger: #fb5607;
            --font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Emotion Colors */
            --emotion-happy: #ffbe0b;
            --emotion-sad: #3a86ff;
            --emotion-angry: #fb5607;
            --emotion-fearful: #8338ec;
            --emotion-disgusted: #06ffa5;
            --emotion-surprised: #ff006e;
            
            /* Smart Home Status Colors */
            --status-on: #06ffa5;
            --status-off: #adb5bd;
            --status-warning: #ffbe0b;
            --status-danger: #fb5607;
            
            /* Location Colors */
            --location-home: #06ffa5;
            --location-work: #4361ee;
            --location-classroom: #ff006e;
            --location-other: #ffbe0b;
            
            /* Priority Colors */
            --priority-high: #fb5607;
            --priority-medium: #ffbe0b;
            --priority-low: #06ffa5;
        }

        [data-theme="dark"] {
            /* Dark Theme Variables */
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-chat: #2d2d2d;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --accent: #7209b7;
            --accent-hover: #560bad;
            --msg-user: #7209b7;
            --msg-bot: #343a40;
            --border: #495057;
            --shadow: 0 4px 6px rgba(0,0,0,0.2);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            transition: background-color 0.3s, color 0.3s, border-color 0.3s; 
        }
        
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            height: 100vh; 
            display: flex; 
            overflow: hidden;
            font-size: 14px;
        }

        /* --- Components --- */
        button { 
            cursor: pointer; 
            border: none; 
            outline: none; 
            font-family: inherit; 
            font-weight: 500;
        }
        
        input, textarea, select { 
            font-family: inherit; 
            border: 1px solid var(--border); 
            background: var(--bg-card); 
            color: var(--text-primary); 
            padding: 10px 15px; 
            border-radius: 8px; 
            font-size: 14px;
        }
        
        .icon-btn { 
            background: transparent; 
            color: var(--text-secondary); 
            padding: 8px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 36px;
            height: 36px;
        }
        
        .icon-btn:hover { 
            background-color: rgba(67, 97, 238, 0.1); 
            color: var(--accent); 
        }
        
        .primary-btn { 
            background-color: var(--accent); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: 600;
            box-shadow: var(--shadow);
        }
        
        .primary-btn:hover { 
            background-color: var(--accent-hover); 
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--accent), #7209b7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #login-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .login-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .login-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-type {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .login-type:hover {
            background: var(--bg-chat);
        }

        .login-type.active {
            background: rgba(67, 97, 238, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        /* --- Layout --- */
        /* Sidebar */
        aside { 
            width: 280px; 
            background-color: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            z-index: 10; 
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        
        .logo { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--accent); 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: -0.5px;
        }
        
        .nav-menu { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
            flex: 1; 
        }
        
        .nav-item { 
            padding: 12px 15px; 
            border-radius: 10px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--text-secondary); 
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-item:hover, .nav-item.active { 
            background-color: rgba(67, 97, 238, 0.1); 
            color: var(--accent); 
        }
        
        .user-profile { 
            padding-top: 20px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
            background-color: #ddd; 
        }
        
        .user-info h4 { 
            font-size: 0.9rem; 
            margin-bottom: 2px; 
        }
        
        .user-info p { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
        }
        
        /* Main Content */
        main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
        }
        
        header { 
            height: 70px; 
            background-color: var(--bg-card); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 25px;
            box-shadow: var(--shadow);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-title { 
            font-size: 1.2rem; 
            font-weight: 600; 
        }
        
        .header-actions { 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        
        .datetime-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-right: 15px;
        }
        
        .date-display {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .time-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .content-area { 
            flex: 1; 
            overflow: hidden; 
            position: relative; 
            display: flex; 
        }
        
        /* Panels */
        .panel { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--bg-body); 
            padding: 25px; 
            overflow-y: auto; 
            display: none; 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        
        .panel.active { 
            display: block; 
            opacity: 1; 
        }

        /* --- Chat Interface --- */
        .chat-container { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            max-width: 900px; 
            margin: 0 auto; 
            background: var(--bg-card); 
            border-radius: 16px; 
            box-shadow: var(--shadow-lg); 
            overflow: hidden; 
        }
        
        .chat-history { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            background-color: var(--bg-chat); 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .message { 
            max-width: 80%; 
            padding: 12px 16px; 
            border-radius: 18px; 
            line-height: 1.5; 
            font-size: 0.95rem; 
            position: relative; 
            animation: fadeIn 0.3s ease; 
        }
        
        .message.user { 
            align-self: flex-end; 
            background-color: var(--msg-user); 
            color: white; 
            border-bottom-right-radius: 4px; 
        }
        
        .message.bot { 
            align-self: flex-start; 
            background-color: var(--msg-bot); 
            color: var(--text-primary); 
            border-bottom-left-radius: 4px; 
            position: relative;
        }
        
        .message .meta { 
            font-size: 0.7rem; 
            opacity: 0.7; 
            margin-top: 5px; 
            display: block; 
            text-align: right; 
        }
        
        .message .sentiment { 
            font-size: 0.7rem; 
            margin-top: 5px; 
            display: block; 
            text-align: left; 
            opacity: 0.7; 
        }
        
        .message.positive .sentiment { 
            color: var(--success); 
        }
        
        .message.negative .sentiment { 
            color: var(--danger); 
        }
        
        .message.neutral .sentiment { 
            color: var(--text-secondary); 
        }
        
        /* Emotion indicators */
        .emotion-indicator { 
            display: inline-flex; 
            align-items: center; 
            margin-left: 8px; 
            font-size: 0.8rem; 
        }
        
        .emotion-indicator span { 
            margin-right: 4px; 
        }
        
        .emotion-happy { 
            color: var(--emotion-happy); 
        }
        
        .emotion-sad { 
            color: var(--emotion-sad); 
        }
        
        .emotion-angry { 
            color: var(--emotion-angry); 
        }
        
        .emotion-fearful { 
            color: var(--emotion-fearful); 
        }
        
        .emotion-disgusted { 
            color: var(--emotion-disgusted); 
        }
        
        .emotion-surprised { 
            color: var(--emotion-surprised); 
        }
        
        .input-area { 
            padding: 15px; 
            background-color: var(--bg-card); 
            border-top: 1px solid var(--border); 
            display: flex; 
            gap: 10px; 
            align-items: flex-end; 
        }
        
        .input-area textarea { 
            flex: 1; 
            resize: none; 
            height: 50px; 
            min-height: 40px; 
            max-height: 120px; 
            border-radius: 20px; 
            padding: 12px 15px; 
            border: 1px solid var(--border); 
            background: var(--bg-chat); 
        }
        
        .input-area button { 
            height: 45px; 
            width: 45px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
        }
        
        /* Message actions */
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-actions button {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            color: var(--text-secondary);
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-actions button:hover {
            background: var(--bg-card);
            color: var(--accent);
        }

        /* --- Dashboard/Widgets --- */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            padding-bottom: 20px; 
        }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .card h3 { 
            margin-bottom: 15px; 
            font-size: 1.1rem; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        /* Task List */
        .task-list { 
            list-style: none; 
        }
        
        .task-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px solid var(--border); 
        }
        
        .task-item.completed span { 
            text-decoration: line-through; 
            opacity: 0.6; 
        }
        
        .task-actions button { 
            padding: 4px; 
            color: var(--text-secondary); 
        }
        
        .task-actions button:hover { 
            color: var(--danger); 
        }

        /* Smart Home - Enhanced with Location */
        .room-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            border-bottom: 1px solid var(--border); 
        }
        
        .room-tab { 
            padding: 8px 15px; 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            font-weight: 500;
        }
        
        .room-tab.active { 
            border-bottom-color: var(--accent); 
            color: var(--accent); 
        }
        
        .room-content { 
            display: none; 
        }
        
        .room-content.active { 
            display: block; 
        }
        
        .device-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
        }
        
        .device { 
            background: var(--bg-chat); 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            border: 2px solid transparent; 
            position: relative; 
            transition: all 0.2s;
        }
        
        .device:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .device.on { 
            border-color: var(--accent); 
            background: rgba(67, 97, 238, 0.1); 
        }
        
        .device-icon { 
            font-size: 2rem; 
            margin-bottom: 10px; 
            display: block; 
        }
        
        .device-status { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
        }
        
        .device-status.on { 
            background-color: var(--status-on); 
        }
        
        .device-status.off { 
            background-color: var(--status-off); 
        }
        
        .device-status.warning { 
            background-color: var(--status-warning); 
        }
        
        .device-status.danger { 
            background-color: var(--status-danger); 
        }
        
        .device-energy { 
            font-size: 0.7rem; 
            color: var(--text-secondary); 
            margin-top: 5px; 
        }
        
        .climate-control { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            margin-top: 10px; 
        }
        
        .temp-display { 
            font-size: 1.5rem; 
            font-weight: bold; 
        }
        
        .temp-control { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .temp-btn { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        
        .security-status { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 10px; 
        }
        
        .security-status.armed { 
            background: rgba(6, 255, 165, 0.1); 
            color: var(--success); 
        }
        
        .security-status.disarmed { 
            background: rgba(173, 181, 189, 0.1); 
            color: var(--text-secondary); 
        }
        
        .security-status.triggered { 
            background: rgba(251, 86, 7, 0.1); 
            color: var(--danger); 
        }
        
        /* Location Management - New Styles */
        .location-management {
            margin-top: 20px;
        }
        
        .location-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .location-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        
        .location-tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }
        
        .location-content {
            display: none;
        }
        
        .location-content.active {
            display: block;
        }
        
        .location-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .location-card {
            background: var(--bg-chat);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid transparent;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .location-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .location-card.current {
            border-color: var(--accent);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .location-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .location-card-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .location-card-type {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-secondary);
        }
        
        .location-card-type.home {
            background: rgba(6, 255, 165, 0.2);
            color: var(--location-home);
        }
        
        .location-card-type.work {
            background: rgba(67, 97, 238, 0.2);
            color: var(--location-work);
        }
        
        .location-card-type.classroom {
            background: rgba(255, 0, 110, 0.2);
            color: var(--location-classroom);
        }
        
        .location-card-type.other {
            background: rgba(255, 190, 11, 0.2);
            color: var(--location-other);
        }
        
        .location-card-coords {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .location-card-radius {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .location-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .location-card-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        .add-location-form {
            background: var(--bg-chat);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        .geofence-map {
            height: 300px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .geofence-map-placeholder {
            display: none;
        }
        
        .geofence-indicator {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed var(--accent);
            background: rgba(67, 97, 238, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .location-automation {
            margin-top: 15px;
            padding: 10px;
            background: var(--bg-chat);
            border-radius: 8px;
        }
        
        .location-automation h4 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .location-automation p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .automation-rules {
            margin-top: 10px;
        }
        
        .automation-rule {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .automation-rule-trigger {
            font-weight: 500;
            flex: 1;
        }
        
        .automation-rule-action {
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex: 2;
        }
        
        .automation-rule-toggle {
            width: 40px;
        }
        
        .current-location-indicator {
            position: fixed;
            bottom: 20px;
            left: 300px;
            background: var(--bg-card);
            border-radius: 30px;
            padding: 8px 15px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 99;
        }
        
        .current-location-indicator .location-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .current-location-indicator .location-text {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .location-permission-banner {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .location-permission-banner i {
            font-size: 1.5rem;
            color: var(--warning);
        }
        
        .location-permission-content {
            flex: 1;
        }
        
        .location-permission-content h4 {
            margin-bottom: 5px;
        }
        
        .location-permission-content p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Translation Panel - Enhanced */
        .translation-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .translation-box {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .lang-select {
            margin-bottom: 10px;
        }
        
        .swap-btn {
            align-self: center;
            background: var(--bg-card);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
        }
        
        .swap-btn:hover {
            background: var(--bg-chat);
        }
        
        .conversation-translation {
            margin-top: 20px;
        }
        
        .conversation-translation h3 {
            margin-bottom: 15px;
        }
        
        .conversation-item {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-chat);
            border-radius: 8px;
        }
        
        .conversation-original {
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .conversation-translated {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .phrase-suggestions {
            margin-top: 20px;
        }
        
        .phrase-suggestion {
            display: inline-block;
            padding: 8px 12px;
            background: var(--bg-chat);
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .phrase-suggestion:hover {
            background: var(--accent);
            color: white;
        }
        
        .voice-translation {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
        }
        
        .voice-translation-btn {
            padding: 8px 15px;
            background: var(--accent);
            color: white;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Smart Planner Styles */
        .planner-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .planner-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .planner-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        
        .planner-tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }
        
        .planner-content {
            display: none;
        }
        
        .planner-content.active {
            display: block;
        }
        
        .task-form {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .task-list {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .planner-task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--bg-chat);
            transition: all 0.2s;
        }
        
        .planner-task-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .planner-task-item.completed {
            opacity: 0.6;
        }
        
        .planner-task-item.completed .task-title {
            text-decoration: line-through;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .task-deadline {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .task-priority {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .priority-high {
            background: rgba(251, 86, 7, 0.2);
            color: var(--priority-high);
        }
        
        .priority-medium {
            background: rgba(255, 190, 11, 0.2);
            color: var(--priority-medium);
        }
        
        .priority-low {
            background: rgba(6, 255, 165, 0.2);
            color: var(--priority-low);
        }
        
        .task-actions {
            display: flex;
            gap: 5px;
        }
        
        .ai-tools {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }
        
        .tool-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tool-card {
            padding: 15px;
            border-radius: 8px;
            background: var(--bg-chat);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .tool-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .tool-card.selected {
            border-color: var(--accent);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .tool-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .tool-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .tool-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .tool-form {
            display: none;
            background: var(--bg-chat);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .tool-form.active {
            display: block;
        }
        
        .quiz-questions {
            margin-top: 20px;
        }
        
        .quiz-question {
            background: var(--bg-chat);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .quiz-question h4 {
            margin-bottom: 10px;
        }
        
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .quiz-option {
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quiz-option:hover {
            background: rgba(67, 97, 238, 0.1);
        }
        
        .quiz-option.selected {
            background: rgba(67, 97, 238, 0.2);
            border: 1px solid var(--accent);
        }
        
        .quiz-option.correct {
            background: rgba(6, 255, 165, 0.2);
            border: 1px solid var(--success);
        }
        
        .quiz-option.incorrect {
            background: rgba(251, 86, 7, 0.2);
            border: 1px solid var(--danger);
        }
        
        .quiz-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .quiz-result {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .quiz-result.show {
            display: block;
        }
        
        .quiz-score {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }

        /* Calendar Styles */
        .calendar-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            background: var(--bg-chat);
        }
        
        .calendar-day.today {
            background: var(--accent);
            color: white;
            font-weight: bold;
        }
        
        .calendar-day.has-event {
            position: relative;
        }
        
        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--warning);
        }
        
        .calendar-day.holiday {
            color: var(--danger);
            font-weight: 600;
        }
        
        .calendar-day.holiday::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--danger);
        }
        
        .event-list {
            margin-top: 20px;
        }
        
        .event-item {
            padding: 10px;
            background: var(--bg-chat);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .event-item.holiday {
            border-left: 4px solid var(--danger);
        }
        
        .event-item.important {
            border-left: 4px solid var(--warning);
        }

        /* Email Styles */
        .email-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .email-list {
            margin-bottom: 20px;
        }
        
        .email-item {
            padding: 15px;
            background: var(--bg-chat);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .email-item:hover {
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }
        
        .email-item.unread {
            border-left: 4px solid var(--accent);
        }
        
        .email-subject {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .email-preview {
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .email-detail {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .email-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Music Styles */
        .music-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .music-player {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .now-playing {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .album-art {
            width: 80px;
            height: 80px;
            background: var(--bg-chat);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-secondary);
        }
        
        .track-info h3 {
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 4px;
            background: var(--bg-chat);
            border-radius: 2px;
            margin-bottom: 15px;
        }
        
        .progress {
            height: 100%;
            width: 30%;
            background: var(--accent);
            border-radius: 2px;
        }
        
        .player-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .playlist {
            margin-top: 20px;
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .playlist-item:hover {
            background: var(--bg-chat);
        }
        
        .playlist-item.playing {
            background: rgba(67, 97, 238, 0.1);
            color: var(--accent);
        }

        /* Fitness Styles */
        .fitness-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-secondary);
        }
        
        .workout-list {
            margin-top: 15px;
        }
        
        .workout-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-chat);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Document Styles */
        .doc-uploader {
            background: var(--bg-chat);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .doc-uploader:hover {
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }
        
        #analysis-results {
            margin-top: 20px;
            display: none;
        }

        /* Admin Styles */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .admin-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        
        .admin-tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }
        
        .admin-content {
            display: none;
        }
        
        .admin-content.active {
            display: block;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .analytics-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .analytics-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 5px;
        }
        
        .analytics-label {
            color: var(--text-secondary);
        }
        
        .privacy-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .privacy-option:last-child {
            border-bottom: none;
        }

        /* Smart Home Widget in Dashboard */
        .smarthome-widget {
            position: relative;
        }
        
        .smarthome-widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .smarthome-widget-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .smarthome-widget-devices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .smarthome-widget-device {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-chat);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .smarthome-widget-device:hover {
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }
        
        .smarthome-widget-device.on {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid var(--accent);
        }
        
        .smarthome-widget-device-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 50%;
        }
        
        .smarthome-widget-device-info {
            flex: 1;
        }
        
        .smarthome-widget-device-name {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .smarthome-widget-device-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .smarthome-widget-scenes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .smarthome-widget-scene {
            padding: 6px 12px;
            background: var(--bg-chat);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .smarthome-widget-scene:hover {
            background: var(--accent);
            color: white;
        }

        /* --- Micro Interactions --- */
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        @keyframes slideUp { 
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        .typing-indicator { 
            display: flex; 
            gap: 4px; 
            padding: 10px; 
            background: var(--msg-bot); 
            border-radius: 18px; 
            width: fit-content; 
            margin-bottom: 10px; 
            display: none; 
        }
        
        .dot { 
            width: 6px; 
            height: 6px; 
            background: var(--text-secondary); 
            border-radius: 50%; 
            animation: bounce 1.4s infinite ease-in-out both; 
        }
        
        .dot:nth-child(1) { 
            animation-delay: -0.32s; 
        }
        
        .dot:nth-child(2) { 
            animation-delay: -0.16s; 
        }
        
        @keyframes bounce { 
            0%, 80%, 100% { 
                transform: scale(0); 
            } 
            40% { 
                transform: scale(1); 
            } 
        }

        /* Toast Notification */
        #toast-container { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .toast { 
            background: var(--bg-card); 
            border-left: 4px solid var(--accent); 
            padding: 15px 20px; 
            border-radius: 8px; 
            box-shadow: var(--shadow-lg); 
            min-width: 250px; 
            animation: slideIn 0.3s; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        
        @keyframes slideIn { 
            from { 
                transform: translateX(100%); 
            } 
            to { 
                transform: translateX(0); 
            } 
        }

        /* Voice Wave Animation */
        .voice-wave { 
            display: flex; 
            align-items: center; 
            height: 30px; 
            gap: 3px; 
            display: none; 
        }
        
        .voice-wave.active { 
            display: flex; 
        }
        
        .bar { 
            width: 3px; 
            height: 5px; 
            background: var(--accent); 
            animation: sound 0ms -800ms linear infinite alternate; 
        }
        
        .voice-wave.active .bar { 
            animation-duration: 400ms; 
        }
        
        @keyframes sound { 
            0% { 
                height: 5px; 
                opacity: 0.5; 
            } 
            100% { 
                height: 25px; 
                opacity: 1; 
            } 
        }

        /* Responsive */
        @media (max-width: 768px) {
            aside { 
                position: fixed; 
                left: -280px; 
                height: 100%; 
                transition: 0.3s; 
                box-shadow: 2px 0 10px rgba(0,0,0,0.2); 
            }
            
            aside.open { 
                left: 0; 
            }
            
            .mobile-menu-btn { 
                display: block !important; 
            }
            
            .dashboard-grid { 
                grid-template-columns: 1fr; 
            }
            
            .location-list {
                grid-template-columns: 1fr;
            }
            
            .current-location-indicator {
                left: 20px;
                right: 20px;
            }
            
            .translation-box {
                grid-template-columns: 1fr;
            }
            
            .swap-btn {
                display: none;
            }
            
            .tool-selector {
                grid-template-columns: 1fr;
            }
            
            .quiz-options {
                grid-template-columns: 1fr;
            }
        }
        
        .mobile-menu-btn { 
            display: none; 
            background: none; 
            font-size: 1.5rem; 
            color: var(--text-primary); 
        }

        /* Setup Modal */
        #setup-modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            z-index: 2000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-content { 
            background: var(--bg-card); 
            padding: 30px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 500px; 
            text-align: center; 
            box-shadow: var(--shadow-lg);
        }
        
        .mode-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin: 20px 0; 
        }
        
        .mode-card { 
            border: 1px solid var(--border); 
            padding: 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        
        .mode-card:hover, .mode-card.selected { 
            border-color: var(--accent); 
            background: rgba(67, 97, 238, 0.1); 
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Educational Support Styles */
        .educational-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .edu-tool {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edu-tool:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .edu-tool-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .edu-tool-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .edu-tool-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-robot"></i>
                AIDA
            </div>
            <p class="login-subtitle">AI Virtual Assistant</p>
            
            <div class="login-form">
                <div class="login-type-selector">
                    <div class="login-type active" onclick="selectLoginType('user', this)">
                        <i class="fas fa-user"></i> User
                    </div>
                    <div class="login-type" onclick="selectLoginType('admin', this)">
                        <i class="fas fa-user-shield"></i> Admin
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" placeholder="Enter your username">
                </div>
                
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                
                <button class="primary-btn" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                
                <div class="login-error" id="login-error">
                    Invalid username or password. Please try again.
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" style="display: none;">
        <div class="modal-content">
            <h2 style="margin-bottom: 10px;">Welcome to AIDA</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Let's customize your assistant experience.</p>
            
            <div style="text-align: left; margin-bottom: 5px;">Your Name:</div>
            <input type="text" id="setup-name" placeholder="e.g. Alex" style="width: 100%; margin-bottom: 15px;">
            
            <div style="text-align: left; margin-bottom: 5px;">Select Assistant Mode:</div>
            <div class="mode-grid">
                <div class="mode-card selected" onclick="selectMode('student', this)">
                    <div style="font-size: 1.5rem;"></div>
                    <div>Student</div>
                </div>
                <div class="mode-card" onclick="selectMode('productivity', this)">
                    <div style="font-size: 1.5rem;"></div>
                    <div>Productivity</div>
                </div>
                <div class="mode-card" onclick="selectMode('health', this)">
                    <div style="font-size: 1.5rem;"></div>
                    <div>Health</div>
                </div>
                <div class="mode-card" onclick="selectMode('home', this)">
                    <div style="font-size: 1.5rem;"></div>
                    <div>Smart Home</div>
                </div>
            </div>
            
            <!-- Privacy Settings -->
            <div style="text-align: left; margin-top: 20px; margin-bottom: 5px;">Privacy Settings:</div>
            <div class="privacy-settings">
                <div class="privacy-option">
                    <span>Save conversation history</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="save-history" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="privacy-option">
                    <span>Use voice data for improvement</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="voice-data">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="privacy-option">
                    <span>Personalized responses</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="personalized-responses" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="privacy-option">
                    <span>Enable proactive suggestions</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="proactive-suggestions" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="privacy-option">
                    <span>Enable location services</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="location-services" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <button class="primary-btn" onclick="completeSetup()" style="width: 100%; margin-top: 20px;">Start Assistant</button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="logo">
            <i class="fas fa-robot"></i>
            AIDA
        </div>
        
        <nav class="nav-menu">
            <div class="nav-item active" onclick="switchTab('chat')">
                <i class="fas fa-comment"></i> Chat
            </div>
            <div class="nav-item" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-item" onclick="switchTab('planner')">
                <i class="fas fa-tasks"></i> Smart Planner
            </div>
            <div class="nav-item" onclick="switchTab('tasks')">
                <i class="fas fa-check-circle"></i> Tasks
            </div>
            <div class="nav-item" onclick="switchTab('calendar')">
                <i class="fas fa-calendar"></i> Calendar
            </div>
            <div class="nav-item" onclick="switchTab('email')">
                <i class="fas fa-envelope"></i> Email
            </div>
            <div class="nav-item" onclick="switchTab('music')">
                <i class="fas fa-music"></i> Music
            </div>
            <div class="nav-item" onclick="switchTab('fitness')">
                <i class="fas fa-dumbbell"></i> Fitness
            </div>
            <div class="nav-item" onclick="switchTab('translate')">
                <i class="fas fa-language"></i> Translate
            </div>
            <div class="nav-item" onclick="switchTab('docs')">
                <i class="fas fa-file-alt"></i> Document AI
            </div>
            <div class="nav-item" onclick="switchTab('smarthome')">
                <i class="fas fa-home"></i> Smart Home
            </div>
            <div class="nav-item" onclick="switchTab('admin')" id="admin-nav-item" style="display: none;">
                <i class="fas fa-cog"></i> Admin
            </div>
        </nav>

        <div class="user-profile">
            <img src="https://picsum.photos/seed/alex/100/100.jpg" alt="User" class="avatar" id="user-avatar">
            <div class="user-info">
                <h4 id="display-name">Guest</h4>
                <p id="display-mode">User Mode</p>
            </div>
            <button class="icon-btn" onclick="toggleTheme()" style="margin-left: auto;">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
            <button class="icon-btn" onclick="logout()" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main>
        <header>
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-title" id="page-title">Chat Assistant</div>
            </div>
            
            <div class="datetime-display">
                <div class="date-display" id="date-display">Monday, January 1, 2023</div>
                <div class="time-display" id="time-display">12:00 PM</div>
            </div>
            
            <div class="header-actions">
                <div class="voice-wave" id="voice-indicator">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
                <!-- Smart Home Quick Access in Header -->
                <button class="icon-btn" onclick="toggleHeaderSmarthome()" title="Smart Home Quick Access">
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button class="icon-btn" title="Settings" onclick="showToast('Settings locked in demo mode', 'info')">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <div class="content-area">
            
            <!-- Chat Panel -->
            <div id="panel-chat" class="panel active">
                <div class="chat-container">
                    <div class="chat-history" id="chat-history">
                        <!-- Messages injected here -->
                        <div class="message bot">
                            Hello! I'm AIDA. How can I help you today?
                            <span class="meta">Just now</span>
                            <div class="message-actions">
                                <button onclick="speakMessage(this)" title="Speak">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                    </div>

                    <div class="input-area">
                        <textarea id="user-input" placeholder="Type a message or use voice..." onkeydown="handleEnter(event)"></textarea>
                        <button class="icon-btn" style="background: transparent; color: var(--text-secondary);" onclick="toggleVoice()" title="Voice Mode">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="primary-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Panel -->
            <div id="panel-dashboard" class="panel">
                <h2>Good <span id="time-of-day">Morning</span>, <span id="dash-name">User</span>!</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Here's your daily overview.</p>
                
                <div class="dashboard-grid">
                    <!-- Smart Home Widget in Dashboard -->
                    <div class="card smarthome-widget">
                        <div class="smarthome-widget-header">
                            <h3><i class="fas fa-home"></i> Smart Home</h3>
                            <span class="smarthome-widget-status" id="smarthome-status">4 devices active</span>
                        </div>
                        <div class="smarthome-widget-devices">
                            <div class="smarthome-widget-device" onclick="toggleDashboardDevice('Light 1', this)">
                                <span class="smarthome-widget-device-icon"><i class="fas fa-lightbulb"></i></span>
                                <div class="smarthome-widget-device-info">
                                    <div class="smarthome-widget-device-name">Main Light</div>
                                    <div class="smarthome-widget-device-status">Off</div>
                                </div>
                            </div>
                            <div class="smarthome-widget-device" onclick="toggleDashboardDevice('AC', this)">
                                <span class="smarthome-widget-device-icon"><i class="fas fa-snowflake"></i></span>
                                <div class="smarthome-widget-device-info">
                                    <div class="smarthome-widget-device-name">AC</div>
                                    <div class="smarthome-widget-device-status">Off</div>
                                </div>
                            </div>
                            <div class="smarthome-widget-device" onclick="toggleDashboardDevice('Fan', this)">
                                <span class="smarthome-widget-device-icon"><i class="fas fa-fan"></i></span>
                                <div class="smarthome-widget-device-info">
                                    <div class="smarthome-widget-device-name">Fan</div>
                                    <div class="smarthome-widget-device-status">Off</div>
                                </div>
                            </div>
                            <div class="smarthome-widget-device on" onclick="toggleDashboardDevice('Lock', this)">
                                <span class="smarthome-widget-device-icon"><i class="fas fa-lock"></i></span>
                                <div class="smarthome-widget-device-info">
                                    <div class="smarthome-widget-device-name">Front Door</div>
                                    <div class="smarthome-widget-device-status">Locked</div>
                                </div>
                            </div>
                        </div>
                        <div class="smarthome-widget-scenes">
                            <button class="smarthome-widget-scene" onclick="executeScene('good-morning')">Good Morning</button>
                            <button class="smarthome-widget-scene" onclick="executeScene('good-night')">Good Night</button>
                            <button class="smarthome-widget-scene" onclick="executeScene('movie-time')">Movie Time</button>
                            <button class="smarthome-widget-scene" onclick="executeScene('away')">Away Mode</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-cloud-sun"></i> Weather</h3>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 2.5rem;"></span>
                            <div>
                                <div style="font-size: 1.8rem; font-weight: bold;">22C</div>
                                <div style="color: var(--text-secondary);">Sunny, Vadlamudi</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-newspaper"></i> News Briefing</h3>
                        <ul style="list-style: none; color: var(--text-secondary); font-size: 0.9rem;">
                            <li style="margin-bottom: 8px;"> Tech giants announce new AI standards...</li>
                            <li style="margin-bottom: 8px;"> Global markets show positive trends...</li>
                            <li> New study reveals productivity tips...</li>
                        </ul>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-lightbulb"></i> Focus Tips</h3>
                        <p id="tip-text" style="font-style: italic; color: var(--text-secondary);">"The secret of getting ahead is getting started."</p>
                        <button class="primary-btn" style="margin-top: 10px; font-size: 0.8rem;" onclick="getNewTip()">New Tip</button>
                    </div>
                </div>
            </div>

            <!-- Smart Planner Panel -->
            <div id="panel-planner" class="panel">
                <div class="planner-container">
                    <h2>Smart Planner</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Organize your tasks and leverage AI tools to boost productivity</p>
                    
                    <div class="planner-tabs">
                        <div class="planner-tab active" onclick="switchPlannerTab('tasks')">Tasks</div>
                        <div class="planner-tab" onclick="switchPlannerTab('ai-tools')">AI Tools</div>
                    </div>
                    
                    <!-- Tasks Tab -->
                    <div id="planner-tasks" class="planner-content active">
                        <div class="task-form">
                            <h3>Add New Task</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label for="task-title">Task/Subject</label>
                                    <input type="text" id="task-title" placeholder="e.g., Complete project proposal">
                                </div>
                                <div class="form-group">
                                    <label for="task-deadline">Date/Deadline</label>
                                    <input type="date" id="task-deadline">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="task-priority">Priority</label>
                                <select id="task-priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="task-description">Description (Optional)</label>
                                <textarea id="task-description" rows="3" placeholder="Add any additional details..."></textarea>
                            </div>
                            <button class="primary-btn" onclick="addPlannerTask()">
                                <i class="fas fa-plus"></i> Add Task
                            </button>
                        </div>
                        
                        <div class="task-list">
                            <h3>Task List</h3>
                            <div id="planner-task-list">
                                <!-- Tasks will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Tools Tab -->
                    <div id="planner-ai-tools" class="planner-content">
                        <div class="ai-tools">
                            <h3>AI Tools</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">Leverage AI to enhance your learning and productivity</p>
                            
                            <div class="tool-selector">
                                <div class="tool-card" onclick="selectTool('quiz-generator', this)">
                                    <div class="tool-icon">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="tool-name">Quick Quiz Generator</div>
                                    <div class="tool-description">Generate quizzes on any topic</div>
                                </div>
                                <div class="tool-card" onclick="selectTool('summary-generator', this)">
                                    <div class="tool-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="tool-name">Summary Generator</div>
                                    <div class="tool-description">Create concise summaries</div>
                                </div>
                                <div class="tool-card" onclick="selectTool('flashcard-generator', this)">
                                    <div class="tool-icon">
                                        <i class="fas fa-layer-group"></i>
                                    </div>
                                    <div class="tool-name">Flashcard Generator</div>
                                    <div class="tool-description">Create study flashcards</div>
                                </div>
                                <div class="tool-card" onclick="selectTool('study-plan', this)">
                                    <div class="tool-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div class="tool-name">Study Plan Creator</div>
                                    <div class="tool-description">Generate personalized study plans</div>
                                </div>
                            </div>
                            
                            <!-- Quiz Generator Tool -->
                            <div id="tool-quiz-generator" class="tool-form">
                                <h3>Quick Quiz Generator</h3>
                                <div class="form-group">
                                    <label for="quiz-topic">Topic/Subject</label>
                                    <input type="text" id="quiz-topic" placeholder="e.g., World War II, Photosynthesis, JavaScript">
                                </div>
                                <div class="form-group">
                                    <label for="quiz-questions">Number of Questions</label>
                                    <input type="number" id="quiz-questions" min="1" max="20" value="5">
                                </div>
                                <div class="form-group">
                                    <label for="quiz-difficulty">Difficulty Level</label>
                                    <select id="quiz-difficulty">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <button class="primary-btn" onclick="generateQuiz()">
                                    <i class="fas fa-magic"></i> Generate Quiz
                                </button>
                                
                                <div id="quiz-container" class="quiz-questions">
                                    <!-- Quiz questions will be populated here -->
                                </div>
                                
                                <div id="quiz-result" class="quiz-result">
                                    <div class="quiz-score">Score: 0/0</div>
                                    <div>Great job! Keep practicing to improve your knowledge.</div>
                                    <button class="primary-btn" style="margin-top: 15px;" onclick="resetQuiz()">
                                        <i class="fas fa-redo"></i> Try Again
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Summary Generator Tool -->
                            <div id="tool-summary-generator" class="tool-form">
                                <h3>Summary Generator</h3>
                                <div class="form-group">
                                    <label for="summary-text">Text to Summarize</label>
                                    <textarea id="summary-text" rows="8" placeholder="Paste or type the text you want to summarize..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="summary-length">Summary Length</label>
                                    <select id="summary-length">
                                        <option value="brief">Brief (1-2 sentences)</option>
                                        <option value="short" selected>Short (1 paragraph)</option>
                                        <option value="medium">Medium (2-3 paragraphs)</option>
                                        <option value="detailed">Detailed (4-5 paragraphs)</option>
                                    </select>
                                </div>
                                <button class="primary-btn" onclick="generateSummary()">
                                    <i class="fas fa-magic"></i> Generate Summary
                                </button>
                                
                                <div id="summary-result" style="margin-top: 20px; padding: 15px; background: var(--bg-chat); border-radius: 8px; display: none;">
                                    <h4>Summary:</h4>
                                    <p id="summary-content"></p>
                                    <button class="icon-btn" style="margin-top: 10px;" onclick="copySummary()" title="Copy Summary">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Flashcard Generator Tool -->
                            <div id="tool-flashcard-generator" class="tool-form">
                                <h3>Flashcard Generator</h3>
                                <div class="form-group">
                                    <label for="flashcard-topic">Topic/Subject</label>
                                    <input type="text" id="flashcard-topic" placeholder="e.g., Biology, History, Programming">
                                </div>
                                <div class="form-group">
                                    <label for="flashcard-count">Number of Flashcards</label>
                                    <input type="number" id="flashcard-count" min="1" max="20" value="10">
                                </div>
                                <button class="primary-btn" onclick="generateFlashcards()">
                                    <i class="fas fa-magic"></i> Generate Flashcards
                                </button>
                                
                                <div id="flashcard-container" style="margin-top: 20px; display: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4>Flashcards</h4>
                                        <div>
                                            <button class="icon-btn" onclick="previousFlashcard()" title="Previous">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <span id="flashcard-counter">1 / 10</span>
                                            <button class="icon-btn" onclick="nextFlashcard()" title="Next">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="flashcard" style="min-height: 200px; background: var(--bg-chat); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer;" onclick="flipFlashcard()">
                                        <div id="flashcard-front" style="font-size: 1.2rem; font-weight: 600;">
                                            Click to reveal answer
                                        </div>
                                        <div id="flashcard-back" style="display: none; font-size: 1.1rem;">
                                            Answer will appear here
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                                        <button class="icon-btn" onclick="markFlashcard('easy')" title="Easy">
                                            <i class="fas fa-smile" style="color: var(--success);"></i>
                                        </button>
                                        <button class="icon-btn" onclick="markFlashcard('medium')" title="Medium">
                                            <i class="fas fa-meh" style="color: var(--warning);"></i>
                                        </button>
                                        <button class="icon-btn" onclick="markFlashcard('hard')" title="Hard">
                                            <i class="fas fa-frown" style="color: var(--danger);"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Study Plan Creator Tool -->
                            <div id="tool-study-plan" class="tool-form">
                                <h3>Study Plan Creator</h3>
                                <div class="form-group">
                                    <label for="study-subject">Subject/Topic</label>
                                    <input type="text" id="study-subject" placeholder="e.g., Mathematics, Physics, Literature">
                                </div>
                                <div class="form-group">
                                    <label for="study-duration">Study Duration (weeks)</label>
                                    <input type="number" id="study-duration" min="1" max="12" value="4">
                                </div>
                                <div class="form-group">
                                    <label for="study-hours">Hours per Day</label>
                                    <input type="number" id="study-hours" min="0.5" max="8" step="0.5" value="2">
                                </div>
                                <div class="form-group">
                                    <label for="study-goal">Learning Goal</label>
                                    <textarea id="study-goal" rows="3" placeholder="e.g., Prepare for final exam, Complete online course, Learn basic concepts"></textarea>
                                </div>
                                <button class="primary-btn" onclick="generateStudyPlan()">
                                    <i class="fas fa-magic"></i> Generate Study Plan
                                </button>
                                
                                <div id="study-plan-result" style="margin-top: 20px; display: none;">
                                    <div class="card">
                                        <h4>Your Personalized Study Plan</h4>
                                        <div id="study-plan-content">
                                            <!-- Study plan will be populated here -->
                                        </div>
                                        <button class="icon-btn" style="margin-top: 10px;" onclick="downloadStudyPlan()" title="Download Study Plan">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Panel -->
            <div id="panel-tasks" class="panel">
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>My Tasks</h2>
                        <button class="primary-btn" onclick="document.getElementById('new-task-input').focus()">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" id="new-task-input" placeholder="What needs to be done?" style="flex: 1;">
                            <button class="primary-btn" onclick="addTask()">Add</button>
                        </div>
                        <ul class="task-list" id="task-list-ui">
                            <!-- Tasks injected here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Calendar Panel -->
            <div id="panel-calendar" class="panel">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="icon-btn" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 id="calendar-month-year">June 2023</h2>
                        <button class="icon-btn" onclick="changeMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar days will be generated by JS -->
                    </div>
                    
                    <div class="event-list">
                        <h3>Upcoming Events</h3>
                        <div id="events-list">
                            <div class="event-item">
                                <div><strong>Team Meeting</strong></div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Today, 2:00 PM</div>
                            </div>
                            <div class="event-item">
                                <div><strong>Project Deadline</strong></div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Tomorrow, 5:00 PM</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="primary-btn" onclick="showToast('Calendar integration would connect to your Google/Outlook calendar', 'info')">
                            <i class="fas fa-sync"></i> Connect Calendar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email Panel -->
            <div id="panel-email" class="panel">
                <div class="email-container">
                    <h2>Email Assistant</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">AI-powered email management and response suggestions</p>
                    
                    <div class="email-list">
                        <div class="email-item unread" onclick="openEmail(1)">
                            <div class="email-subject">Project Update Required</div>
                            <div class="email-preview">Hi, could you please provide an update on the current status of the project...</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">From: manager@company.com</div>
                        </div>
                        <div class="email-item" onclick="openEmail(2)">
                            <div class="email-subject">Meeting Tomorrow</div>
                            <div class="email-preview">Just a reminder about our meeting scheduled for tomorrow at 10 AM...</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">From: colleague@company.com</div>
                        </div>
                        <div class="email-item" onclick="openEmail(3)">
                            <div class="email-subject">Invoice #12345</div>
                            <div class="email-preview">Please find attached the invoice for last month's services...</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">From: billing@service.com</div>
                        </div>
                    </div>
                    
                    <div class="email-detail" id="email-detail">
                        <h3 id="email-detail-subject">Email Subject</h3>
                        <div id="email-detail-content">Email content would appear here...</div>
                        <div class="email-actions">
                            <button class="primary-btn" onclick="generateReply()">
                                <i class="fas fa-reply"></i> Generate Reply
                            </button>
                            <button class="icon-btn" title="Mark as read">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="icon-btn" title="Archive">
                                <i class="fas fa-archive"></i>
                            </button>
                            <button class="icon-btn" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="primary-btn" onclick="showToast('Email integration would connect to your Gmail/Outlook account', 'info')">
                            <i class="fas fa-sync"></i> Connect Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- Music Panel -->
            <div id="panel-music" class="panel">
                <div class="music-container">
                    <h2>Music & Podcasts</h2>
                    
                    <div class="music-player">
                        <div class="now-playing">
                            <div class="album-art">
                                <i class="fas fa-music"></i>
                            </div>
                            <div class="track-info">
                                <h3 id="track-name">Focus Flow</h3>
                                <p id="artist-name">Ambient Study</p>
                            </div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress" id="music-progress"></div>
                        </div>
                        
                        <div class="player-controls">
                            <button class="icon-btn">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="icon-btn" id="play-pause-btn" onclick="togglePlayPause()">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="icon-btn">
                                <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                            <span id="current-time">1:23</span>
                            <span id="total-time">3:45</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Playlists</h3>
                        <div class="playlist">
                            <div class="playlist-item playing" onclick="playTrack('Focus Flow', 'Ambient Study')">
                                <span style="margin-right: 10px;">
                                    <i class="fas fa-music"></i>
                                </span>
                                <div style="flex: 1;">
                                    <div>Focus Flow</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Ambient Study</div>
                                </div>
                                <span>3:45</span>
                            </div>
                            <div class="playlist-item" onclick="playTrack('Deep Concentration', 'Study Beats')">
                                <span style="margin-right: 10px;">
                                    <i class="fas fa-music"></i>
                                </span>
                                <div style="flex: 1;">
                                    <div>Deep Concentration</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Study Beats</div>
                                </div>
                                <span>4:12</span>
                            </div>
                            <div class="playlist-item" onclick="playTrack('Nature Sounds', 'Relaxation')">
                                <span style="margin-right: 10px;">
                                    <i class="fas fa-music"></i>
                                </span>
                                <div style="flex: 1;">
                                    <div>Nature Sounds</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Relaxation</div>
                                </div>
                                <span>5:30</span>
                            </div>
                            <div class="playlist-item" onclick="playTrack('Tech Podcast', 'Episode 42')">
                                <span style="margin-right: 10px;">
                                    <i class="fas fa-podcast"></i>
                                </span>
                                <div style="flex: 1;">
                                    <div>Tech Podcast</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Episode 42: AI Trends</div>
                                </div>
                                <span>32:15</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="primary-btn" onclick="showToast('Music integration would connect to Spotify/Apple Music', 'info')">
                            <i class="fas fa-sync"></i> Connect Music Service
                        </button>
                    </div>
                </div>
            </div>

            <!-- Fitness Panel -->
            <div id="panel-fitness" class="panel">
                <div class="fitness-container">
                    <h2>Fitness Tracker</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="steps-count">8,432</div>
                            <div class="stat-label">Steps Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="calories-count">420</div>
                            <div class="stat-label">Calories Burned</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="active-minutes">45</div>
                            <div class="stat-label">Active Minutes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="heart-rate">72</div>
                            <div class="stat-label">Heart Rate</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Today's Workouts</h3>
                        <div class="workout-list">
                            <div class="workout-item">
                                <div>
                                    <div>Morning Yoga</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">7:00 AM - 7:30 AM</div>
                                </div>
                                <button class="icon-btn">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                            <div class="workout-item">
                                <div>
                                    <div>Evening Run</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">6:00 PM - 6:30 PM</div>
                                </div>
                                <button class="icon-btn">
                                    <i class="far fa-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3>Recommended Activities</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                            <button class="primary-btn" onclick="startWorkout('cardio')">
                                <i class="fas fa-running"></i> Start Cardio
                            </button>
                            <button class="primary-btn" onclick="startWorkout('strength')">
                                <i class="fas fa-dumbbell"></i> Strength Training
                            </button>
                            <button class="primary-btn" onclick="startWorkout('yoga')">
                                <i class="fas fa-spa"></i> Yoga Session
                            </button>
                            <button class="primary-btn" onclick="startWorkout('meditation')">
                                <i class="fas fa-brain"></i> Meditation
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="primary-btn" onclick="showToast('Fitness integration would connect to Fitbit/Apple Health', 'info')">
                            <i class="fas fa-sync"></i> Connect Fitness Tracker
                        </button>
                    </div>
                </div>
            </div>

            <!-- Translation Panel - Enhanced -->
            <div id="panel-translate" class="panel">
                <div class="translation-container">
                    <h2>Language Translator</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">AI-powered translation</p>
                    
                    <div class="translation-box">
                        <div>
                            <select class="lang-select" id="source-lang">
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ar">Arabic</option>
                                <option value="hi">Hindi</option>
                                <option value="te">Telugu</option>
                                <option value="ta">Tamil</option>
                            </select>
                            <textarea id="source-text" rows="8" placeholder="Enter text to translate..." style="width: 100%; margin-top: 10px;"></textarea>
                        </div>
                        
                        <button class="swap-btn" onclick="swapLanguages()">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        
                        <div>
                            <select class="lang-select" id="target-lang">
                                <option value="en">English</option>
                                <option value="es" selected>Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ar">Arabic</option>
                                <option value="hi">Hindi</option>
                                <option value="te">Telugu</option>
                                <option value="ta">Tamil</option>
                            </select>
                            <textarea id="translated-text" rows="8" placeholder="Translation will appear here..." style="width: 100%; margin-top: 10px;" readonly></textarea>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="primary-btn" onclick="translateText()">
                            <i class="fas fa-language"></i> Translate
                        </button>
                        <button class="icon-btn" onclick="copyTranslation()" title="Copy translation" style="margin-left: 10px;">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="icon-btn" onclick="speakTranslation()" title="Speak translation" style="margin-left: 5px;">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                    
                    <!-- Conversation Translation -->
                    <div class="conversation-translation">
                        <h3>Conversation Translation</h3>
                        <div id="conversation-history">
                            <div class="conversation-item">
                                <div class="conversation-original">Hello, how are you today?</div>
                                <div class="conversation-translated">Hola, cmo ests hoy?</div>
                            </div>
                            <div class="conversation-item">
                                <div class="conversation-original">I'm doing well, thank you!</div>
                                <div class="conversation-translated">Estoy bien, gracias!</div>
                            </div>
                        </div>
                        <button class="primary-btn" style="margin-top: 10px;" onclick="addConversationTranslation()">
                            <i class="fas fa-plus"></i> Add to Conversation
                        </button>
                    </div>
                    
                    <!-- Phrase Suggestions -->
                    <div class="phrase-suggestions">
                        <h3>Phrase Suggestions</h3>
                        <div id="phrase-suggestions">
                            <div class="phrase-suggestion" onclick="translatePhrase('Hello, how are you?')">Hello</div>
                            <div class="phrase-suggestion" onclick="translatePhrase('Thank you very much')">Thank you</div>
                            <div class="phrase-suggestion" onclick="translatePhrase('Where is the nearest restaurant?')">Restaurant</div>
                            <div class="phrase-suggestion" onclick="translatePhrase('How much does this cost?')">Cost</div>
                        </div>
                    </div>
                    
                    <!-- Voice Translation -->
                    <div class="voice-translation">
                        <h3>Voice Translation</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Speak to translate in real-time</p>
                        <button class="voice-translation-btn" onclick="toggleVoiceTranslation()">
                            <i id="voice-translation-icon" class="fas fa-microphone"></i> 
                            <span id="voice-translation-text">Start Voice Translation</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Document Panel -->
            <div id="panel-docs" class="panel">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2>Document Assistant</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Upload a text file or paste text to analyze.</p>
                    
                    <div class="doc-uploader" onclick="document.getElementById('file-upload').click()">
                        <div style="font-size: 2rem; margin-bottom: 10px;">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <h3>Click to Upload .txt</h3>
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">Or paste content below</p>
                        <input type="file" id="file-upload" style="display: none;" accept=".txt" onchange="handleFileUpload(this)">
                    </div>

                    <textarea id="doc-content" rows="10" placeholder="Paste your text here for analysis..." style="width: 100%; margin-bottom: 10px;"></textarea>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="primary-btn" onclick="analyzeDocument()">
                            <i class="fas fa-search"></i> Analyze
                        </button>
                        <button class="icon-btn" style="border: 1px solid var(--border); border-radius: 8px;" onclick="clearDoc()">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>

                    <div id="analysis-results">
                        <h3>Analysis Results:</h3>
                        <div id="analysis-content"></div>
                    </div>
                </div>
            </div>

            <!-- Smart Home Panel - Enhanced with Location -->
            <div id="panel-smarthome" class="panel">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2>Smart Home Control</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Manage your devices and location-based automations</p>
                    
                    <!-- Location Permission Banner -->
                    <div id="location-permission-banner" class="location-permission-banner" style="display: none;">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="location-permission-content">
                            <h4>Enable Location Services</h4>
                            <p>Allow location access to enable location-based automations and geofencing features.</p>
                        </div>
                        <button class="primary-btn" onclick="requestLocationPermission()">Enable</button>
                    </div>
                    
                    <!-- Location Management -->
                    <div class="location-management">
                        <h3>Location Management</h3>
                        
                        <div class="location-tabs">
                            <div class="location-tab active" onclick="switchLocationTab('locations')">My Locations</div>
                            <div class="location-tab" onclick="switchLocationTab('add')">Add Location</div>
                            <div class="location-tab" onclick="switchLocationTab('automation')">Automation</div>
                        </div>
                        
                        <!-- My Locations Tab -->
                        <div id="location-locations" class="location-content active">
                            <div class="location-list" id="location-list">
                                <!-- Locations will be populated here -->
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button class="primary-btn" onclick="getCurrentLocation()">
                                    <i class="fas fa-crosshairs"></i> Get Current Location
                                </button>
                            </div>
                        </div>
                        
                        <!-- Add Location Tab -->
                        <div id="location-add" class="location-content">
                            <div class="add-location-form">
                                <div class="form-group">
                                    <label for="location-name">Location Name</label>
                                    <input type="text" id="location-name" placeholder="e.g., Home, Work, Classroom">
                                </div>
                                
                                <div class="form-group">
                                    <label for="location-type">Location Type</label>
                                    <select id="location-type">
                                        <option value="home">Home</option>
                                        <option value="work">Office</option>
                                        <option value="classroom">Classroom</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="location-radius">Geofence Radius (meters)</label>
                                    <input type="number" id="location-radius" min="10" max="500" value="90">
                                </div>
                                
                                <div class="form-actions">
                                    <button class="primary-btn" onclick="getCurrentPositionForLocation()">
                                        <i class="fas fa-crosshairs"></i> Use Current Position
                                    </button>
                                    <button class="primary-btn" onclick="saveLocation()">
                                        <i class="fas fa-save"></i> Save Location
                                    </button>
                                </div>
                            </div>
                            
                            <div class="geofence-map" id="geofence-map">
                                <div class="geofence-map-placeholder">
                                    <i class="fas fa-map-marked-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>Map preview would appear here</p>
                                    <p style="font-size: 0.8rem; margin-top: 5px;">In a real implementation, this would show an interactive map</p>
                                </div>
                                <div class="geofence-indicator" id="geofence-indicator" style="display: none;">
                                    <i class="fas fa-home"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Automation Tab -->
                        <div id="location-automation-tab" class="location-content">
                            <div class="card">
                                <h3>Location-Based Automation</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">Configure actions that trigger when you enter or leave specific locations.</p>
                                
                                <div class="automation-rules" id="automation-rules">
                                    <!-- Automation rules will be populated here -->
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button class="primary-btn" onclick="addAutomationRule()">
                                        <i class="fas fa-plus"></i> Add Rule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Room Tabs -->
                    <div class="room-tabs" style="margin-top: 30px;">
                        <div class="room-tab active" onclick="switchRoom('living-room')">Living Room</div>
                        <div class="room-tab" onclick="switchRoom('bedroom')">Bedroom</div>
                        <div class="room-tab" onclick="switchRoom('kitchen')">Kitchen</div>
                        <div class="room-tab" onclick="switchRoom('security')">Security</div>
                    </div>
                    
                    <!-- Living Room -->
                    <div id="room-living-room" class="room-content active">
                        <div class="card">
                            <h3>Living Room</h3>
                            <div class="device-grid">
                                <div class="device" id="dev-light-1" onclick="toggleDevice('Light 1', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-lightbulb"></i>
                                    </span>
                                    <div>Main Light</div>
                                    <div class="device-energy">5W</div>
                                </div>
                                <div class="device" id="dev-ac" onclick="toggleDevice('AC', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-snowflake"></i>
                                    </span>
                                    <div>Air Conditioner</div>
                                    <div class="device-energy">1200W</div>
                                </div>
                                <div class="device" id="dev-tv" onclick="toggleDevice('TV', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-tv"></i>
                                    </span>
                                    <div>Smart TV</div>
                                    <div class="device-energy">85W</div>
                                </div>
                                <div class="device" id="dev-speaker" onclick="toggleDevice('Speaker', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-volume-up"></i>
                                    </span>
                                    <div>Speaker</div>
                                    <div class="device-energy">25W</div>
                                </div>
                            </div>
                            
                            <!-- Climate Control -->
                            <div class="climate-control">
                                <div class="temp-display" id="temp-display">22C</div>
                                <div class="temp-control">
                                    <button class="temp-btn" onclick="adjustTemperature(1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div style="margin: 5px 0;">Temperature</div>
                                    <button class="temp-btn" onclick="adjustTemperature(-1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bedroom -->
                    <div id="room-bedroom" class="room-content">
                        <div class="card">
                            <h3>Bedroom</h3>
                            <div class="device-grid">
                                <div class="device" id="dev-light-2" onclick="toggleDevice('Light 2', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-lightbulb"></i>
                                    </span>
                                    <div>Bedroom Light</div>
                                    <div class="device-energy">8W</div>
                                </div>
                                <div class="device" id="dev-fan" onclick="toggleDevice('Fan', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-fan"></i>
                                    </span>
                                    <div>Ceiling Fan</div>
                                    <div class="device-energy">45W</div>
                                </div>
                                <div class="device" id="dev-humidifier" onclick="toggleDevice('Humidifier', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-tint"></i>
                                    </span>
                                    <div>Humidifier</div>
                                    <div class="device-energy">30W</div>
                                </div>
                                <div class="device" id="dev-alarm" onclick="toggleDevice('Alarm', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-bell"></i>
                                    </span>
                                    <div>Smart Alarm</div>
                                    <div class="device-energy">2W</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kitchen -->
                    <div id="room-kitchen" class="room-content">
                        <div class="card">
                            <h3>Kitchen</h3>
                            <div class="device-grid">
                                <div class="device" id="dev-light-3" onclick="toggleDevice('Light 3', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-lightbulb"></i>
                                    </span>
                                    <div>Kitchen Light</div>
                                    <div class="device-energy">10W</div>
                                </div>
                                <div class="device" id="dev-coffee" onclick="toggleDevice('Coffee', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-coffee"></i>
                                    </span>
                                    <div>Coffee Maker</div>
                                    <div class="device-energy">900W</div>
                                </div>
                                <div class="device" id="dev-fridge" onclick="toggleDevice('Fridge', this)">
                                    <span class="device-status on"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-snowflake"></i>
                                    </span>
                                    <div>Refrigerator</div>
                                    <div class="device-energy">150W</div>
                                </div>
                                <div class="device" id="dev-dishwasher" onclick="toggleDevice('Dishwasher', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-sink"></i>
                                    </span>
                                    <div>Dishwasher</div>
                                    <div class="device-energy">1800W</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security -->
                    <div id="room-security" class="room-content">
                        <div class="card">
                            <h3>Security System</h3>
                            <div class="device-grid">
                                <div class="device" id="dev-lock" onclick="toggleDevice('Lock', this)">
                                    <span class="device-status on"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <div>Front Door</div>
                                    <div class="device-energy">5W</div>
                                </div>
                                <div class="device" id="dev-cam" onclick="toggleDevice('Cam', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-video"></i>
                                    </span>
                                    <div>Camera</div>
                                    <div class="device-energy">8W</div>
                                </div>
                                <div class="device" id="dev-sensor" onclick="toggleDevice('Sensor', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-wifi"></i>
                                    </span>
                                    <div>Motion Sensor</div>
                                    <div class="device-energy">1W</div>
                                </div>
                                <div class="device" id="dev-siren" onclick="toggleDevice('Siren', this)">
                                    <span class="device-status off"></span>
                                    <span class="device-icon">
                                        <i class="fas fa-bell"></i>
                                    </span>
                                    <div>Security Siren</div>
                                    <div class="device-energy">15W</div>
                                </div>
                            </div>
                            
                            <!-- Security Status -->
                            <div class="security-status armed" id="security-status">
                                <span style="font-size: 1.5rem;">
                                    <i class="fas fa-shield-alt"></i>
                                </span>
                                <div>
                                    <div style="font-weight: 500;">Security System</div>
                                    <div style="font-size: 0.8rem;">Armed - All sensors active</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3>Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                            <button class="primary-btn" onclick="executeScene('good-morning')">
                                <i class="fas fa-sun"></i> Good Morning
                            </button>
                            <button class="primary-btn" onclick="executeScene('good-night')">
                                <i class="fas fa-moon"></i> Good Night
                            </button>
                            <button class="primary-btn" onclick="executeScene('movie-time')">
                                <i class="fas fa-film"></i> Movie Time
                            </button>
                            <button class="primary-btn" onclick="executeScene('away')">
                                <i class="fas fa-door-open"></i> Away Mode
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="panel-admin" class="panel">
                <div class="admin-container">
                    <h2>Admin Dashboard</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">View analytics and manage privacy settings</p>
                    
                    <div class="admin-tabs">
                        <div class="admin-tab active" onclick="switchAdminTab('analytics')">Analytics</div>
                        <div class="admin-tab" onclick="switchAdminTab('privacy')">Privacy</div>
                    </div>
                    
                    <!-- Analytics Tab -->
                    <div id="admin-analytics" class="admin-content active">
                        <h3>System Analytics</h3>
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <div class="analytics-value" id="total-conversations">1,247</div>
                                <div class="analytics-label">Total Conversations</div>
                            </div>
                            <div class="analytics-card">
                                <div class="analytics-value" id="unique-users">89</div>
                                <div class="analytics-label">Unique Users</div>
                            </div>
                            <div class="analytics-card">
                                <div class="analytics-value" id="avg-response-time">1.2s</div>
                                <div class="analytics-label">Avg Response Time</div>
                            </div>
                            <div class="analytics-card">
                                <div class="analytics-value" id="success-rate">94%</div>
                                <div class="analytics-label">Success Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Privacy Tab -->
                    <div id="admin-privacy" class="admin-content">
                        <h3>Privacy Settings</h3>
                        <div class="card">
                            <h4>Data Collection</h4>
                            <div class="privacy-option">
                                <span>Save conversation history</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="admin-save-history" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="privacy-option">
                                <span>Use voice data for improvement</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="admin-voice-data">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="privacy-option">
                                <span>Personalized responses</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="admin-personalized" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="privacy-option">
                                <span>Share anonymized usage data</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="admin-anonymous-data">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="privacy-option">
                                <span>Enable proactive suggestions</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="admin-proactive-suggestions" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="privacy-option">
                                <span>Enable location services</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="admin-location-services" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Current Location Indicator -->
    <div class="current-location-indicator" id="current-location-indicator">
        <div class="location-icon">
            <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="location-text" id="current-location-text">Vadlamudi</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- State Management ---
        const state = {
            user: "Guest",
            userType: "user", // user or admin
            mode: "student", // student, productivity, health, home
            theme: "light",
            tasks: [],
            plannerTasks: [],
            context: {}, // Stores short-term context
            devices: { 
                "Light 1": false, 
                "Light 2": false,
                "Light 3": false,
                "AC": false, 
                "Lock": true, 
                "Cam": false,
                "TV": false,
                "Speaker": false,
                "Fan": false,
                "Humidifier": false,
                "Alarm": false,
                "Sensor": false,
                "Siren": false,
                "Coffee": false,
                "Fridge": true,
                "Dishwasher": false
            },
            rooms: {
                "living-room": ["Light 1", "AC", "TV", "Speaker"],
                "bedroom": ["Light 2", "Fan", "Humidifier", "Alarm"],
                "kitchen": ["Light 3", "Coffee", "Fridge", "Dishwasher"],
                "security": ["Lock", "Cam", "Sensor", "Siren"]
            },
            currentRoom: "living-room",
            temperature: 22,
            isListening: false,
            isPlaying: false,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            // Location management
            locations: [
                {
                    id: "loc-home",
                    name: "Home",
                    type: "home",
                    latitude: 16.4918, // Vadlamudi coordinates
                    longitude: 80.6583,
                    radius: 90, // 90 meters radius
                    isCurrent: true
                },
                {
                    id: "loc-guntur",
                    name: "Guntur",
                    type: "other",
                    latitude: 16.3068,
                    longitude: 80.4365,
                    radius: 200,
                    isCurrent: false
                },
                {
                    id: "loc-tenali",
                    name: "Tenali",
                    type: "other",
                    latitude: 16.2417,
                    longitude: 80.6478,
                    radius: 200,
                    isCurrent: false
                }
            ],
            currentLocation: null,
            locationPermission: false,
            locationWatchId: null,
            map: null,
            markers: [],
            automationRules: [
                {
                    id: "rule-1",
                    locationId: "loc-home",
                    trigger: "enter",
                    actions: ["Turn on entry lights", "Set thermostat to comfort", "Disarm security"],
                    enabled: true
                },
                {
                    id: "rule-2",
                    locationId: "loc-home",
                    trigger: "exit",
                    actions: ["Turn off all lights", "Set thermostat to eco", "Arm security"],
                    enabled: true
                }
            ],
            // Privacy settings
            privacy: {
                saveHistory: true,
                useVoiceData: false,
                personalizedResponses: true,
                shareAnonymousData: false,
                proactiveSuggestions: true,
                locationServices: true
            },
            // Translation cache
            translationCache: {},
            // Enhanced NLU intents and entities
            intents: [
                {
                    name: "weather_query",
                    examples: [
                        "what's the weather like",
                        "tell me the weather forecast",
                        "is it going to rain today",
                        "how's the weather outside",
                        "will it be sunny tomorrow"
                    ],
                    entities: ["location", "date", "time"]
                },
                {
                    name: "task_management",
                    examples: [
                        "add a task",
                        "create a reminder",
                        "set a to-do",
                        "remind me to",
                        "I need to remember"
                    ],
                    entities: ["task", "date", "time", "priority"]
                },
                {
                    name: "information_lookup",
                    examples: [
                        "what is",
                        "tell me about",
                        "who is",
                        "define",
                        "explain"
                    ],
                    entities: ["topic", "detail_level"]
                },
                {
                    name: "smart_home_control",
                    examples: [
                        "turn on the lights",
                        "switch off the AC",
                        "activate security system",
                        "dim the lights",
                        "set temperature to"
                    ],
                    entities: ["device", "action", "value", "location", "room"]
                },
                {
                    name: "emotion_expression",
                    examples: [
                        "I'm feeling",
                        "I feel",
                        "I'm so",
                        "makes me feel",
                        "I'm in a mood"
                    ],
                    entities: ["emotion", "intensity"]
                },
                {
                    name: "scene_control",
                    examples: [
                        "activate good morning scene",
                        "turn on movie time",
                        "execute away mode",
                        "start good night scene"
                    ],
                    entities: ["scene"]
                },
                {
                    name: "translation_request",
                    examples: [
                        "translate",
                        "how do you say",
                        "what's the word for",
                        "translate this to"
                    ],
                    entities: ["text", "language"]
                },
                {
                    name: "document_analysis",
                    examples: [
                        "analyze this document",
                        "summarize this text",
                        "extract keywords from",
                        "what's the sentiment of"
                    ],
                    entities: ["document", "analysis_type"]
                },
                {
                    name: "music_control",
                    examples: [
                        "play music",
                        "play some music",
                        "start playing",
                        "put on some music",
                        "play a song"
                    ],
                    entities: ["genre", "artist", "song"]
                },
                {
                    name: "time_query",
                    examples: [
                        "what time is it",
                        "what's the time",
                        "current time",
                        "what's today's date",
                        "what day is it"
                    ],
                    entities: []
                }
            ],
            responses: [
                {
                    intent: "weather_query",
                    text: "The weather in {location} is {temperature}C with {conditions}.",
                    type: "text"
                },
                {
                    intent: "task_management",
                    text: "I've added '{task}' to your task list for {date}.",
                    type: "text"
                },
                {
                    intent: "emotion_expression",
                    text: "I understand you're feeling {emotion}. {emotion_response}",
                    type: "text"
                },
                {
                    intent: "smart_home_control",
                    text: "I'll {action} the {device} in the {room}.",
                    type: "text"
                },
                {
                    intent: "scene_control",
                    text: "Activating {scene} scene now.",
                    type: "text"
                },
                {
                    intent: "translation_request",
                    text: "Translating '{text}' to {language}...",
                    type: "text"
                },
                {
                    intent: "document_analysis",
                    text: "Analyzing document for {analysis_type}...",
                    type: "text"
                },
                {
                    intent: "music_control",
                    text: "Playing {genre} music for you.",
                    type: "text"
                },
                {
                    intent: "time_query",
                    text: "The current time is {time} on {day}, {date}.",
                    type: "text"
                }
            ],
            // Analytics data
            analytics: {
                totalConversations: 1247,
                uniqueUsers: 89,
                avgResponseTime: 1.2,
                successRate: 94,
                dailyVolume: [120, 145, 98, 167, 134, 189, 156],
                topIntents: [
                    { name: "weather_query", count: 342 },
                    { name: "task_management", count: 278 },
                    { name: "information_lookup", count: 234 },
                    { name: "smart_home_control", count: 156 },
                    { name: "greeting", count: 123 }
                ]
            },
            // Email data
            emails: [
                {
                    id: 1,
                    subject: "Project Update Required",
                    preview: "Hi, could you please provide an update on the current status of the project...",
                    content: "Hi, could you please provide an update on the current status of the project? We need to know if you're on track to meet the deadline. Please include any challenges you're facing and what support you might need. Thanks!",
                    from: "manager@company.com",
                    read: false
                },
                {
                    id: 2,
                    subject: "Meeting Tomorrow",
                    preview: "Just a reminder about our meeting scheduled for tomorrow at 10 AM...",
                    content: "Just a reminder about our meeting scheduled for tomorrow at 10 AM. We'll be discussing the Q3 roadmap and budget allocations. Please come prepared with your team's requirements and any concerns. The meeting will be in Conference Room B and should last about 2 hours.",
                    from: "colleague@company.com",
                    read: false
                },
                {
                    id: 3,
                    subject: "Invoice #12345",
                    preview: "Please find attached the invoice for last month's services...",
                    content: "Please find attached the invoice for last month's services. The total amount due is $2,450. Payment is due within 30 days. If you have any questions about the charges, please don't hesitate to contact our billing department. Thank you for your business!",
                    from: "billing@service.com",
                    read: false
                }
            ],
            // Quiz data
            quizData: {
                questions: [],
                currentQuestion: 0,
                userAnswers: [],
                score: 0
            },
            // Flashcard data
            flashcardData: {
                cards: [],
                currentCard: 0,
                isFlipped: false
            },
            // Current selected tool
            selectedTool: null,
            // Calendar data
            calendarEvents: [
                { date: new Date(2023, 5, 5), title: "Team Meeting", type: "event" },
                { date: new Date(2023, 5, 12), title: "Project Deadline", type: "event" },
                { date: new Date(2023, 5, 18), title: "Doctor's Appointment", type: "event" },
                { date: new Date(2023, 5, 25), title: "Birthday Party", type: "event" },
                // Holidays
                { date: new Date(2023, 0, 1), title: "New Year's Day", type: "holiday" },
                { date: new Date(2023, 0, 16), title: "Martin Luther King Jr. Day", type: "holiday" },
                { date: new Date(2023, 1, 14), title: "Valentine's Day", type: "holiday" },
                { date: new Date(2023, 1, 20), title: "Presidents' Day", type: "holiday" },
                { date: new Date(2023, 4, 29), title: "Memorial Day", type: "holiday" },
                { date: new Date(2023, 6, 4), title: "Independence Day", type: "holiday" },
                { date: new Date(2023, 8, 4), title: "Labor Day", type: "holiday" },
                { date: new Date(2023, 9, 9), title: "Columbus Day", type: "holiday" },
                { date: new Date(2023, 9, 31), title: "Halloween", type: "holiday" },
                { date: new Date(2023, 10, 11), title: "Veterans Day", type: "holiday" },
                { date: new Date(2023, 10, 23), title: "Thanksgiving", type: "holiday" },
                { date: new Date(2023, 11, 25), title: "Christmas", type: "holiday" }
            ]
        };

        // --- Login System ---
        let loginType = 'user';
        
        // User credentials
        const userCredentials = {
            user: { username: 'user', password: 'password' },
            admin: { username: 'admin', password: 'admin123' }
        };
        
        function selectLoginType(type, element) {
            loginType = type;
            document.querySelectorAll('.login-type').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
        
        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            
            // Validate credentials
            if (userCredentials[loginType] && 
                userCredentials[loginType].username === username && 
                userCredentials[loginType].password === password) {
                
                // Successful login
                state.user = username;
                state.userType = loginType;
                
                // Update UI based on login type
                document.getElementById('display-name').innerText = username;
                document.getElementById('display-mode').innerText = loginType === 'admin' ? 'Admin Mode' : 'User Mode';
                
                // Show/hide admin navigation item
                document.getElementById('admin-nav-item').style.display = loginType === 'admin' ? 'flex' : 'none';
                
                // Hide login screen
                document.getElementById('login-screen').classList.add('hidden');
                
                // Show setup modal for first-time users
                if (loginType === 'user') {
                    document.getElementById('setup-modal').style.display = 'flex';
                } else {
                    // Admin skips setup
                    showToast(`Welcome, ${username}!`, 'success');
                }
                
                // Hide error message if shown
                errorElement.style.display = 'none';
            } else {
                // Failed login
                errorElement.style.display = 'block';
                
                // Shake animation for login form
                const loginContainer = document.querySelector('.login-container');
                loginContainer.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    loginContainer.style.animation = '';
                }, 500);
            }
        }
        
        function logout() {
            // Reset state
            state.user = "Guest";
            state.userType = "user";
            
            // Clear login form
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            
            // Show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Reset to user login type
            loginType = 'user';
            document.querySelectorAll('.login-type').forEach(el => el.classList.remove('active'));
            document.querySelector('.login-type[onclick="selectLoginType(\'user\', this)"]').classList.add('active');
            
            // Hide admin navigation item
            document.getElementById('admin-nav-item').style.display = 'none';
        }
        
        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
        
        // Handle Enter key in login form
        document.getElementById('login-password').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        document.getElementById('login-username').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-password').focus();
            }
        });

        // --- Date and Time Display ---
        function updateDateTime() {
            const now = new Date();
            
            // Update date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            document.getElementById('date-display').textContent = dateString;
            
            // Update time
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const timeString = `${displayHours}:${minutes} ${ampm}`;
            document.getElementById('time-display').textContent = timeString;
            
            // Update greeting based on time
            let greeting;
            if (hours < 12) {
                greeting = "Morning";
            } else if (hours < 18) {
                greeting = "Afternoon";
            } else {
                greeting = "Evening";
            }
            document.getElementById('time-of-day').textContent = greeting;
        }
        
        // Update date and time every second
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Initial call

        // --- Setup & Initialization ---
        function selectMode(mode, el) {
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            state.mode = mode;
        }

        function completeSetup() {
            const nameInput = document.getElementById('setup-name').value;
            if (nameInput.trim()) state.user = nameInput;
            
            // Update privacy settings
            state.privacy.saveHistory = document.getElementById('save-history').checked;
            state.privacy.useVoiceData = document.getElementById('voice-data').checked;
            state.privacy.personalizedResponses = document.getElementById('personalized-responses').checked;
            state.privacy.proactiveSuggestions = document.getElementById('proactive-suggestions').checked;
            state.privacy.locationServices = document.getElementById('location-services').checked;
            
            // Update UI based on inputs
            document.getElementById('display-name').innerText = state.user;
            document.getElementById('dash-name').innerText = state.user;
            document.getElementById('display-mode').innerText = state.mode.charAt(0).toUpperCase() + state.mode.slice(1) + " Mode";
            
            // Set greeting time
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Morning" : hour < 18 ? "Afternoon" : "Evening";
            document.getElementById('time-of-day').innerText = greeting;

            document.getElementById('setup-modal').style.display = 'none';
            
            // Initialize location services if enabled
            if (state.privacy.locationServices) {
                initializeLocationServices();
            }
            
            // Initialize location list
            renderLocationList();
            
            // Initialize automation rules
            renderAutomationRules();
            
            // Initialize calendar with current date
            renderCalendar();
            
            // Update smart home widget status
            updateSmartHomeWidgetStatus();
        }

        // --- Navigation ---
        function switchTab(tabId) {
            // Update Sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active'); // Assumes clicked element

            // Update Panels
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.getElementById(`panel-${tabId}`).classList.add('active');

            // Update Header Title
            const titles = {
                'chat': 'Chat Assistant',
                'dashboard': 'Dashboard',
                'planner': 'Smart Planner',
                'tasks': 'Task Manager',
                'calendar': 'Calendar',
                'email': 'Email Assistant',
                'music': 'Music & Podcasts',
                'fitness': 'Fitness Tracker',
                'translate': 'Language Translator',
                'docs': 'Document AI',
                'smarthome': 'Smart Home',
                'admin': 'Admin Dashboard'
            };
            document.getElementById('page-title').innerText = titles[tabId];

            // Close sidebar on mobile
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
            
            // Initialize specific panel if needed
            if (tabId === 'smarthome') {
                renderLocationList();
                renderAutomationRules();
                initializeMap();
            } else if (tabId === 'calendar') {
                renderCalendar();
            } else if (tabId === 'dashboard') {
                updateSmartHomeWidgetStatus();
            } else if (tabId === 'planner') {
                renderPlannerTasks();
            }
        }

        function switchAdminTab(tabId) {
            // Update Tabs
            document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Update Content
            document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`admin-${tabId}`).classList.add('active');
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
            document.getElementById('theme-icon').className = state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // --- Smart Planner Functions ---
        function switchPlannerTab(tabId) {
            // Update tabs
            document.querySelectorAll('.planner-tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update content
            document.querySelectorAll('.planner-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`planner-${tabId}`).classList.add('active');
        }
        
        function addPlannerTask() {
            const title = document.getElementById('task-title').value;
            const deadline = document.getElementById('task-deadline').value;
            const priority = document.getElementById('task-priority').value;
            const description = document.getElementById('task-description').value;
            
            if (!title || !deadline) {
                showToast('Please fill in the required fields', 'warning');
                return;
            }
            
            const task = {
                id: Date.now(),
                title,
                deadline,
                priority,
                description,
                completed: false
            };
            
            state.plannerTasks.push(task);
            renderPlannerTasks();
            
            // Clear form
            document.getElementById('task-title').value = '';
            document.getElementById('task-deadline').value = '';
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-description').value = '';
            
            showToast('Task added successfully', 'success');
        }
        
        function renderPlannerTasks() {
            const taskList = document.getElementById('planner-task-list');
            
            if (state.plannerTasks.length === 0) {
                taskList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No tasks yet. Add your first task to get started.</p>';
                return;
            }
            
            // Sort tasks by deadline and priority
            const sortedTasks = [...state.plannerTasks].sort((a, b) => {
                // First sort by completion status
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                
                // Then by deadline
                const deadlineA = new Date(a.deadline);
                const deadlineB = new Date(b.deadline);
                
                if (deadlineA !== deadlineB) {
                    return deadlineA - deadlineB;
                }
                
                // Finally by priority
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            taskList.innerHTML = '';
            
            sortedTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `planner-task-item ${task.completed ? 'completed' : ''}`;
                
                const deadlineDate = new Date(task.deadline);
                const formattedDate = deadlineDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} 
                           onchange="togglePlannerTask(${task.id})">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <div class="task-deadline">
                                <i class="fas fa-calendar-alt"></i> ${formattedDate}
                            </div>
                            <div class="task-priority priority-${task.priority}">
                                <i class="fas fa-flag"></i> ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </div>
                        </div>
                        ${task.description ? `<div style="margin-top: 5px; font-size: 0.8rem; color: var(--text-secondary);">${task.description}</div>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="icon-btn" onclick="editPlannerTask(${task.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" onclick="deletePlannerTask(${task.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                taskList.appendChild(taskItem);
            });
        }
        
        function togglePlannerTask(id) {
            const task = state.plannerTasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                renderPlannerTasks();
            }
        }
        
        function editPlannerTask(id) {
            const task = state.plannerTasks.find(t => t.id === id);
            if (!task) return;
            
            // Fill form with task data
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-deadline').value = task.deadline;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-description').value = task.description || '';
            
            // Delete the task (will be re-added when form is submitted)
            deletePlannerTask(id, false);
            
            // Switch to tasks tab
            document.querySelectorAll('.planner-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.planner-tab[onclick="switchPlannerTab(\'tasks\')"]').classList.add('active');
            
            document.querySelectorAll('.planner-content').forEach(content => content.classList.remove('active'));
            document.getElementById('planner-tasks').classList.add('active');
            
            // Focus on the title field
            document.getElementById('task-title').focus();
        }
        
        function deletePlannerTask(id, showMessage = true) {
            state.plannerTasks = state.plannerTasks.filter(t => t.id !== id);
            renderPlannerTasks();
            if (showMessage) showToast('Task deleted', 'success');
        }
        
        // AI Tools Functions
        function selectTool(toolId, element) {
            // Update UI
            document.querySelectorAll('.tool-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            
            // Hide all tool forms
            document.querySelectorAll('.tool-form').forEach(form => form.classList.remove('active'));
            
            // Show selected tool form
            document.getElementById(`tool-${toolId}`).classList.add('active');
            
            // Update state
            state.selectedTool = toolId;
        }
        
        // Quiz Generator Functions
        function generateQuiz() {
            const topic = document.getElementById('quiz-topic').value;
            const numQuestions = parseInt(document.getElementById('quiz-questions').value);
            const difficulty = document.getElementById('quiz-difficulty').value;
            
            if (!topic || !numQuestions) {
                showToast('Please fill in all fields', 'warning');
                return;
            }
            
            // Generate quiz questions (simulated)
            state.quizData.questions = [];
            state.quizData.currentQuestion = 0;
            state.quizData.userAnswers = [];
            state.quizData.score = 0;
            
            // Generate actual quiz questions based on topic
            const quizQuestions = generateQuizQuestions(topic, numQuestions, difficulty);
            
            state.quizData.questions = quizQuestions;
            
            // Render first question
            renderQuizQuestion();
            
            // Show quiz container
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('quiz-result').classList.remove('show');
            
            showToast(`Quiz generated with ${numQuestions} questions on ${topic}`, 'success');
        }
        
        function generateQuizQuestions(topic, numQuestions, difficulty) {
            // Generate actual quiz questions based on topic
            const questions = [];
            
            // Topic-specific question banks
            const questionBanks = {
                "World War II": [
                    {
                        question: "When did World War II begin?",
                        options: ["1914", "1939", "1945", "1950"],
                        correct: 1
                    },
                    {
                        question: "Which country was not part of the Axis powers?",
                        options: ["Germany", "Italy", "Japan", "United Kingdom"],
                        correct: 3
                    },
                    {
                        question: "What event marked the end of World War II in Europe?",
                        options: ["D-Day", "Battle of Stalingrad", "V-E Day", "Pearl Harbor"],
                        correct: 2
                    },
                    {
                        question: "Who was the leader of the Soviet Union during most of World War II?",
                        options: ["Lenin", "Stalin", "Khrushchev", "Gorbachev"],
                        correct: 1
                    },
                    {
                        question: "Which battle is considered the turning point in the Pacific Theater?",
                        options: ["Battle of Midway", "Battle of Iwo Jima", "Attack on Pearl Harbor", "Battle of Okinawa"],
                        correct: 0
                    }
                ],
                "Photosynthesis": [
                    {
                        question: "What is the primary pigment involved in photosynthesis?",
                        options: ["Carotene", "Chlorophyll", "Xanthophyll", "Anthocyanin"],
                        correct: 1
                    },
                    {
                        question: "What gas is produced during photosynthesis?",
                        options: ["Carbon dioxide", "Nitrogen", "Oxygen", "Hydrogen"],
                        correct: 2
                    },
                    {
                        question: "In which part of the plant cell does photosynthesis primarily occur?",
                        options: ["Nucleus", "Mitochondria", "Chloroplast", "Ribosome"],
                        correct: 2
                    },
                    {
                        question: "What is the chemical equation for photosynthesis?",
                        options: ["6CO2 + 6H2O  C6H12O6 + 6O2", "C6H12O6 + 6O2  6CO2 + 6H2O", "6CO2 + 6O2  C6H12O6 + 6H2O", "C6H12O6 + 6H2O  6CO2 + 6O2"],
                        correct: 0
                    },
                    {
                        question: "Which of the following is NOT a product of the light-dependent reactions?",
                        options: ["ATP", "NADPH", "Oxygen", "Glucose"],
                        correct: 3
                    }
                ],
                "JavaScript": [
                    {
                        question: "Which of the following is NOT a JavaScript data type?",
                        options: ["Number", "String", "Float", "Boolean"],
                        correct: 2
                    },
                    {
                        question: "What does the 'typeof' operator return for an array?",
                        options: ["'array'", "'object'", "'list'", "'collection'"],
                        correct: 1
                    },
                    {
                        question: "Which method adds one or more elements to the end of an array?",
                        options: ["push()", "pop()", "shift()", "unshift()"],
                        correct: 0
                    },
                    {
                        question: "What is the correct way to write a JavaScript array?",
                        options: ["var colors = 'red', 'green', 'blue'", "var colors = ['red', 'green', 'blue']", "var colors = (1:'red', 2:'green', 3:'blue')", "var colors = 1 = ('red'), 2 = ('green'), 3 = ('blue')"],
                        correct: 1
                    },
                    {
                        question: "Which event occurs when the user clicks on an HTML element?",
                        options: ["onchange", "onclick", "onmouseclick", "onmouseover"],
                        correct: 1
                    }
                ]
            };
            
            // Get questions for the topic or generate generic ones
            let topicQuestions = questionBanks[topic] || [];
            
            // If we don't have enough questions for the topic, generate generic ones
            if (topicQuestions.length < numQuestions) {
                const genericQuestions = [
                    {
                        question: `What is the primary purpose of ${topic}?`,
                        options: ["Option A", "Option B", "Option C", "Option D"],
                        correct: Math.floor(Math.random() * 4)
                    },
                    {
                        question: `Which of the following is a key concept in ${topic}?`,
                        options: ["Option A", "Option B", "Option C", "Option D"],
                        correct: Math.floor(Math.random() * 4)
                    },
                    {
                        question: `How would you apply ${topic} in a practical situation?`,
                        options: ["Option A", "Option B", "Option C", "Option D"],
                        correct: Math.floor(Math.random() * 4)
                    },
                    {
                        question: `What are the main components of ${topic}?`,
                        options: ["Option A", "Option B", "Option C", "Option D"],
                        correct: Math.floor(Math.random() * 4)
                    },
                    {
                        question: `What is a common misconception about ${topic}?`,
                        options: ["Option A", "Option B", "Option C", "Option D"],
                        correct: Math.floor(Math.random() * 4)
                    }
                ];
                
                topicQuestions = [...topicQuestions, ...genericQuestions];
            }
            
            // Select the required number of questions
            for (let i = 0; i < numQuestions; i++) {
                const questionIndex = i % topicQuestions.length;
                const question = { ...topicQuestions[questionIndex], id: i };
                questions.push(question);
            }
            
            return questions;
        }
        
        function renderQuizQuestion() {
            const container = document.getElementById('quiz-container');
            const question = state.quizData.questions[state.quizData.currentQuestion];
            
            if (!question) {
                showQuizResults();
                return;
            }
            
            let optionsHTML = '';
            question.options.forEach((option, index) => {
                optionsHTML += `
                    <div class="quiz-option" onclick="selectQuizOption(${index})">
                        ${option}
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="quiz-question">
                    <h4>Question ${state.quizData.currentQuestion + 1} of ${state.quizData.questions.length}</h4>
                    <p>${question.question}</p>
                    <div class="quiz-options">
                        ${optionsHTML}
                    </div>
                </div>
                <div class="quiz-actions">
                    <button class="icon-btn" onclick="previousQuizQuestion()" ${state.quizData.currentQuestion === 0 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="primary-btn" onclick="nextQuizQuestion()" id="next-quiz-btn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
            
            // Restore selected option if already answered
            if (state.quizData.userAnswers[state.quizData.currentQuestion] !== undefined) {
                const options = container.querySelectorAll('.quiz-option');
                options[state.quizData.userAnswers[state.quizData.currentQuestion]].classList.add('selected');
            }
        }
        
        function selectQuizOption(index) {
            // Update UI
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(option => option.classList.remove('selected'));
            options[index].classList.add('selected');
            
            // Store answer
            state.quizData.userAnswers[state.quizData.currentQuestion] = index;
        }
        
        function nextQuizQuestion() {
            // Check if an option is selected
            if (state.quizData.userAnswers[state.quizData.currentQuestion] === undefined) {
                showToast('Please select an answer', 'warning');
                return;
            }
            
            // Move to next question
            state.quizData.currentQuestion++;
            
            if (state.quizData.currentQuestion >= state.quizData.questions.length) {
                showQuizResults();
            } else {
                renderQuizQuestion();
            }
        }
        
        function previousQuizQuestion() {
            if (state.quizData.currentQuestion > 0) {
                state.quizData.currentQuestion--;
                renderQuizQuestion();
            }
        }
        
        function showQuizResults() {
            // Calculate score
            state.quizData.score = 0;
            state.quizData.questions.forEach((question, index) => {
                if (state.quizData.userAnswers[index] === question.correct) {
                    state.quizData.score++;
                }
            });
            
            // Show results
            const resultContainer = document.getElementById('quiz-result');
            const scorePercent = Math.round((state.quizData.score / state.quizData.questions.length) * 100);
            
            let feedback = '';
            if (scorePercent >= 80) {
                feedback = 'Excellent work! You have a strong understanding of this topic.';
            } else if (scorePercent >= 60) {
                feedback = 'Good job! With a bit more practice, you\'ll master this topic.';
            } else {
                feedback = 'Keep studying! Review the material and try again to improve your score.';
            }
            
            // Generate answer review
            let answerReviewHTML = '<h4>Answer Review:</h4><div style="text-align: left; margin-top: 15px;">';
            
            state.quizData.questions.forEach((question, index) => {
                const isCorrect = state.quizData.userAnswers[index] === question.correct;
                const userAnswer = state.quizData.userAnswers[index] !== undefined ? 
                    question.options[state.quizData.userAnswers[index]] : 'Not answered';
                const correctAnswer = question.options[question.correct];
                
                answerReviewHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-chat); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">Q${index + 1}: ${question.question}</div>
                        <div style="font-size: 0.9rem;">
                            Your answer: <span style="${isCorrect ? 'color: var(--success);' : 'color: var(--danger);'}">${userAnswer}</span>
                            ${!isCorrect ? `<br>Correct answer: <span style="color: var(--success);">${correctAnswer}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            answerReviewHTML += '</div>';
            
            resultContainer.innerHTML = `
                <div class="quiz-score">${state.quizData.score}/${state.quizData.questions.length} (${scorePercent}%)</div>
                <div>${feedback}</div>
                ${answerReviewHTML}
                <button class="primary-btn" style="margin-top: 15px;" onclick="resetQuiz()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            `;
            
            resultContainer.classList.add('show');
            document.getElementById('quiz-container').style.display = 'none';
        }
        
        function resetQuiz() {
            state.quizData = {
                questions: [],
                currentQuestion: 0,
                userAnswers: [],
                score: 0
            };
            
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('quiz-result').classList.remove('show');
        }
        
        // Summary Generator Functions
        function generateSummary() {
            const text = document.getElementById('summary-text').value;
            const length = document.getElementById('summary-length').value;
            
            if (!text) {
                showToast('Please enter text to summarize', 'warning');
                return;
            }
            
            // Simulate summary generation
            let summaryLength;
            switch (length) {
                case 'brief':
                    summaryLength = 1; // 1-2 sentences
                    break;
                case 'short':
                    summaryLength = 3; // 1 paragraph
                    break;
                case 'medium':
                    summaryLength = 5; // 2-3 paragraphs
                    break;
                case 'detailed':
                    summaryLength = 7; // 4-5 paragraphs
                    break;
                default:
                    summaryLength = 3;
            }
            
            // Show loading state
            document.getElementById('summary-content').textContent = 'Generating summary...';
            document.getElementById('summary-result').style.display = 'block';
            
            // Simulate API call
            setTimeout(() => {
                const summary = generateActualSummary(text, summaryLength);
                document.getElementById('summary-content').textContent = summary;
                showToast('Summary generated successfully', 'success');
            }, 1500);
        }
        
        function generateActualSummary(text, length) {
            // Enhanced summary generation that actually summarizes content
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
            
            if (sentences.length === 0) {
                return "No content to summarize.";
            }
            
            // For demonstration, we'll use a simple extractive summarization approach
            // In a real implementation, this would use an AI API
            
            // Calculate sentence importance based on word frequency
            const wordFrequency = {};
            const allWords = text.toLowerCase().match(/\w+/g) || [];
            
            // Count word frequency
            allWords.forEach(word => {
                if (!wordFrequency[word]) {
                    wordFrequency[word] = 0;
                }
                wordFrequency[word]++;
            });
            
            // Score sentences based on word frequency
            const sentenceScores = sentences.map((sentence, index) => {
                const words = sentence.toLowerCase().match(/\w+/g) || [];
                let score = 0;
                
                words.forEach(word => {
                    if (wordFrequency[word]) {
                        score += wordFrequency[word];
                    }
                });
                
                // Normalize by sentence length
                return { sentence, score: score / words.length, index };
            });
            
            // Sort sentences by score
            sentenceScores.sort((a, b) => b.score - a.score);
            
            // Select top sentences based on requested length
            let summarySentences = [];
            
            switch (length) {
                case 1: // Brief (1-2 sentences)
                    summarySentences = sentenceScores.slice(0, 2).map(item => item.sentence);
                    break;
                case 3: // Short (1 paragraph)
                    summarySentences = sentenceScores.slice(0, 3).map(item => item.sentence);
                    break;
                case 5: // Medium (2-3 paragraphs)
                    summarySentences = sentenceScores.slice(0, 5).map(item => item.sentence);
                    break;
                case 7: // Detailed (4-5 paragraphs)
                    summarySentences = sentenceScores.slice(0, 7).map(item => item.sentence);
                    break;
                default:
                    summarySentences = sentenceScores.slice(0, 3).map(item => item.sentence);
            }
            
            // Sort by original order to maintain coherence
            summarySentences.sort((a, b) => {
                const aIndex = sentences.indexOf(a);
                const bIndex = sentences.indexOf(b);
                return aIndex - bIndex;
            });
            
            // Join sentences into summary
            let summary = summarySentences.join(' ').trim();
            
            // Ensure summary ends with proper punctuation
            if (summary && !summary.match(/[.!?]$/)) {
                summary += '.';
            }
            
            return summary || "Unable to generate a summary from the provided text.";
        }
        
        function copySummary() {
            const summary = document.getElementById('summary-content').textContent;
            if (!summary) return;
            
            navigator.clipboard.writeText(summary).then(() => {
                showToast('Summary copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy summary', 'warning');
            });
        }
        
        // Flashcard Generator Functions
        function generateFlashcards() {
            const topic = document.getElementById('flashcard-topic').value;
            const count = parseInt(document.getElementById('flashcard-count').value);
            
            if (!topic || !count) {
                showToast('Please fill in all fields', 'warning');
                return;
            }
            
            // Generate flashcards (simulated)
            state.flashcardData.cards = [];
            state.flashcardData.currentCard = 0;
            state.flashcardData.isFlipped = false;
            
            // Generate actual flashcards based on topic
            const flashcards = generateFlashcardsForTopic(topic, count);
            
            state.flashcardData.cards = flashcards;
            
            // Show first flashcard
            renderFlashcard();
            
            // Show flashcard container
            document.getElementById('flashcard-container').style.display = 'block';
            
            showToast(`${count} flashcards generated for ${topic}`, 'success');
        }
        
        function generateFlashcardsForTopic(topic, count) {
            // Generate actual flashcards based on topic
            const flashcards = [];
            
            // Topic-specific flashcard banks
            const flashcardBanks = {
                "Biology": [
                    { front: "What is photosynthesis?", back: "The process by which green plants and some other organisms use sunlight to synthesize foods from carbon dioxide and water." },
                    { front: "What is the function of mitochondria?", back: "Mitochondria are organelles that generate most of the cell's supply of adenosine triphosphate (ATP), used as a source of chemical energy." },
                    { front: "What is DNA?", back: "DNA (deoxyribonucleic acid) is a molecule that carries the genetic instructions for the development, functioning, growth, and reproduction of all known organisms." },
                    { front: "What is mitosis?", back: "Mitosis is a part of the cell cycle in which replicated chromosomes are separated into two new nuclei." },
                    { front: "What is the function of ribosomes?", back: "Ribosomes are the cell's protein factories, reading messenger RNA to produce proteins." },
                    { front: "What is the cell membrane?", back: "The cell membrane is a biological membrane that separates the interior of all cells from the outside environment." },
                    { front: "What is the function of the nucleus?", back: "The nucleus is an organelle that contains the cell's genetic material and controls the cell's growth and reproduction." },
                    { front: "What is osmosis?", back: "Osmosis is the movement of water molecules across a semipermeable membrane from a region of lower solute concentration to a region of higher solute concentration." },
                    { front: "What is the function of chloroplasts?", back: "Chloroplasts are organelles that conduct photosynthesis, where the photosynthetic pigment chlorophyll captures the energy from sunlight." },
                    { front: "What is the endoplasmic reticulum?", back: "The endoplasmic reticulum is a type of organelle in eukaryotic cells that forms an interconnected network of flattened, membrane-enclosed sacs or tube-like structures." }
                ],
                "History": [
                    { front: "When did World War II begin?", back: "World War II began on September 1, 1939, when Germany invaded Poland." },
                    { front: "Who was the first President of the United States?", back: "George Washington was the first President of the United States, serving from 1789 to 1797." },
                    { front: "What was the Renaissance?", back: "The Renaissance was a period of cultural, artistic, political, and economic rebirth following the Middle Ages in Europe." },
                    { front: "When did the Roman Empire fall?", back: "The Western Roman Empire fell in 476 AD when the last emperor, Romulus Augustulus, was deposed." },
                    { front: "What was the Industrial Revolution?", back: "The Industrial Revolution was the transition to new manufacturing processes in Europe and the United States, from about 1760 to sometime between 1820 and 1840." },
                    { front: "Who wrote the Declaration of Independence?", back: "Thomas Jefferson wrote the Declaration of Independence, which was adopted by the Second Continental Congress on July 4, 1776." },
                    { front: "What was the Cold War?", back: "The Cold War was a period of geopolitical tension between the United States and the Soviet Union and their respective allies, from 1947 to 1991." },
                    { front: "When did the American Civil War take place?", back: "The American Civil War was fought from 1861 to 1865 between the United States (the Union) and the Confederate States of America (the Confederacy)." },
                    { front: "Who was Cleopatra?", back: "Cleopatra VII Philopator was the last active ruler of the Ptolemaic Kingdom of Egypt, from 51 to 30 BC." },
                    { front: "What was the Magna Carta?", back: "The Magna Carta was a charter of rights agreed to by King John of England in 1215, which promised the protection of church rights, legal protection, and limitations on feudal payments." }
                ],
                "Programming": [
                    { front: "What is a variable?", back: "A variable is a symbolic name that is a reference or pointer to an object. It's used to store data values that can be changed during program execution." },
                    { front: "What is a function?", back: "A function is a block of organized, reusable code that is used to perform a single, related action." },
                    { front: "What is an array?", back: "An array is a data structure consisting of a collection of elements, each identified by at least one array index or key." },
                    { front: "What is a loop?", back: "A loop is a sequence of instructions that is continually repeated until a certain condition is reached." },
                    { front: "What is object-oriented programming?", back: "Object-oriented programming (OOP) is a programming paradigm based on the concept of 'objects', which can contain data and code." },
                    { front: "What is a conditional statement?", back: "A conditional statement performs different actions depending on whether a specified condition evaluates to true or false." },
                    { front: "What is a recursive function?", back: "A recursive function is a function that calls itself, either directly or indirectly, to solve a problem." },
                    { front: "What is an API?", back: "An API (Application Programming Interface) is a set of definitions and protocols for building and integrating application software." },
                    { front: "What is a database?", back: "A database is an organized collection of structured information, or data, typically stored electronically in a computer system." },
                    { front: "What is version control?", back: "Version control is a system that records changes to a file or set of files over time so that you can recall specific versions later." }
                ]
            };
            
            // Get flashcards for the topic or generate generic ones
            let topicFlashcards = flashcardBanks[topic] || [];
            
            // If we don't have enough flashcards for the topic, generate generic ones
            if (topicFlashcards.length < count) {
                const genericFlashcards = [
                    { front: `What is the definition of ${topic}?`, back: `${topic} is a field of study that involves the systematic investigation of fundamental principles and concepts.` },
                    { front: `What are the key components of ${topic}?`, back: `The key components of ${topic} include theoretical frameworks, practical applications, and emerging trends.` },
                    { front: `How is ${topic} applied in real-world situations?`, back: `${topic} is applied in various industries and contexts to solve complex problems and improve efficiency.` },
                    { front: `What are some common misconceptions about ${topic}?`, back: `A common misconception about ${topic} is that it's only relevant to specialists, when in fact it has broad applications.` },
                    { front: `What are the current trends in ${topic}?`, back: `Current trends in ${topic} include integration with technology, interdisciplinary approaches, and sustainability considerations.` }
                ];
                
                topicFlashcards = [...topicFlashcards, ...genericFlashcards];
            }
            
            // Select the required number of flashcards
            for (let i = 0; i < count; i++) {
                const flashcardIndex = i % topicFlashcards.length;
                const flashcard = { ...topicFlashcards[flashcardIndex], id: i };
                flashcards.push(flashcard);
            }
            
            return flashcards;
        }
        
        function renderFlashcard() {
            if (state.flashcardData.cards.length === 0) return;
            
            const card = state.flashcardData.cards[state.flashcardData.currentCard];
            
            document.getElementById('flashcard-front').textContent = card.front;
            document.getElementById('flashcard-back').textContent = card.back;
            document.getElementById('flashcard-counter').textContent = 
                `${state.flashcardData.currentCard + 1} / ${state.flashcardData.cards.length}`;
            
            // Reset flip state
            state.flashcardData.isFlipped = false;
            document.getElementById('flashcard-front').style.display = 'block';
            document.getElementById('flashcard-back').style.display = 'none';
        }
        
        function flipFlashcard() {
            state.flashcardData.isFlipped = !state.flashcardData.isFlipped;
            
            if (state.flashcardData.isFlipped) {
                document.getElementById('flashcard-front').style.display = 'none';
                document.getElementById('flashcard-back').style.display = 'block';
            } else {
                document.getElementById('flashcard-front').style.display = 'block';
                document.getElementById('flashcard-back').style.display = 'none';
            }
        }
        
        function nextFlashcard() {
            if (state.flashcardData.currentCard < state.flashcardData.cards.length - 1) {
                state.flashcardData.currentCard++;
                renderFlashcard();
            }
        }
        
        function previousFlashcard() {
            if (state.flashcardData.currentCard > 0) {
                state.flashcardData.currentCard--;
                renderFlashcard();
            }
        }
        
        function markFlashcard(difficulty) {
            // In a real app, this would update the spaced repetition algorithm
            showToast(`Marked as ${difficulty}`, 'info');
            
            // Move to next card
            if (state.flashcardData.currentCard < state.flashcardData.cards.length - 1) {
                nextFlashcard();
            } else {
                showToast('You\'ve reviewed all flashcards!', 'success');
            }
        }
        
        // Study Plan Creator Functions
        function generateStudyPlan() {
            const subject = document.getElementById('study-subject').value;
            const duration = parseInt(document.getElementById('study-duration').value);
            const hoursPerDay = parseFloat(document.getElementById('study-hours').value);
            const goal = document.getElementById('study-goal').value;
            
            if (!subject || !duration || !hoursPerDay || !goal) {
                showToast('Please fill in all fields', 'warning');
                return;
            }
            
            // Generate study plan (simulated)
            const plan = generateAdvancedStudyPlan(subject, duration, hoursPerDay, goal);
            
            document.getElementById('study-plan-content').innerHTML = plan;
            document.getElementById('study-plan-result').style.display = 'block';
            
            showToast('Study plan generated successfully', 'success');
        }
        
        function generateAdvancedStudyPlan(subject, duration, hoursPerDay, goal) {
            // Generate an advanced study plan with more detailed information
            let planHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>Study Overview</h4>
                    <p><strong>Subject:</strong> ${subject}</p>
                    <p><strong>Duration:</strong> ${duration} weeks</p>
                    <p><strong>Daily Study Time:</strong> ${hoursPerDay} hours</p>
                    <p><strong>Goal:</strong> ${goal}</p>
                </div>
                
                <h4>Weekly Schedule</h4>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; font-weight: 600;">Mon</div>
                    <div style="text-align: center; font-weight: 600;">Tue</div>
                    <div style="text-align: center; font-weight: 600;">Wed</div>
                    <div style="text-align: center; font-weight: 600;">Thu</div>
                    <div style="text-align: center; font-weight: 600;">Fri</div>
                    <div style="text-align: center; font-weight: 600;">Sat</div>
                    <div style="text-align: center; font-weight: 600;">Sun</div>
                </div>
            `;
            
            // Generate weekly topics with more detail
            const topics = generateAdvancedStudyTopics(subject, duration, hoursPerDay);
            
            for (let week = 1; week <= duration; week++) {
                planHTML += `
                    <div style="margin-bottom: 20px;">
                        <h5>Week ${week}</h5>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                `;
                
                for (let day = 1; day <= 7; day++) {
                    const dayTopic = topics[(week - 1) * 7 + (day - 1)] || 'Review';
                    const isRestDay = day === 7; // Sunday as rest day
                    
                    planHTML += `
                        <div style="padding: 10px; background: ${isRestDay ? 'var(--bg-chat)' : 'var(--bg-card)'}; border-radius: 8px; font-size: 0.8rem;">
                            ${isRestDay ? 'Rest Day' : dayTopic}
                        </div>
                    `;
                }
                
                planHTML += `
                        </div>
                    </div>
                `;
            }
            
            // Add study resources
            planHTML += `
                <div style="margin-top: 20px;">
                    <h4>Recommended Resources</h4>
                    <ul style="padding-left: 20px;">
                        <li>Textbooks: ${getSubjectTextbooks(subject)}</li>
                        <li>Online Courses: ${getSubjectCourses(subject)}</li>
                        <li>Practice Materials: ${getSubjectPracticeMaterials(subject)}</li>
                        <li>Study Groups: Join or form a study group for collaborative learning</li>
                    </ul>
                </div>
            `;
            
            // Add study techniques
            planHTML += `
                <div style="margin-top: 20px;">
                    <h4>Effective Study Techniques</h4>
                    <ul style="padding-left: 20px;">
                        <li>Active Recall: Test yourself regularly instead of just re-reading</li>
                        <li>Spaced Repetition: Review material at increasing intervals</li>
                        <li>Pomodoro Technique: Study for 25 minutes, then take a 5-minute break</li>
                        <li>Feynman Technique: Explain concepts in simple terms to identify knowledge gaps</li>
                        <li>Mind Mapping: Create visual representations of complex information</li>
                    </ul>
                </div>
            `;
            
            // Add progress tracking
            planHTML += `
                <div style="margin-top: 20px;">
                    <h4>Progress Tracking</h4>
                    <p>Track your progress with these metrics:</p>
                    <ul style="padding-left: 20px;">
                        <li>Daily study hours completed</li>
                        <li>Topics covered vs. topics planned</li>
                        <li>Practice test scores</li>
                        <li>Confidence level with each topic (1-10 scale)</li>
                    </ul>
                    <p>Review your progress weekly and adjust your plan as needed.</p>
                </div>
            `;
            
            // Add motivation and tips
            planHTML += `
                <div style="margin-top: 20px;">
                    <h4>Motivation & Tips</h4>
                    <ul style="padding-left: 20px;">
                        <li>Set specific, achievable goals for each study session</li>
                        <li>Create a dedicated study space free from distractions</li>
                        <li>Stay hydrated and maintain a balanced diet</li>
                        <li>Get at least 7-8 hours of sleep for better retention</li>
                        <li>Reward yourself for reaching milestones</li>
                        <li>Connect with others who are studying the same subject</li>
                    </ul>
                </div>
            `;
            
            return planHTML;
        }
        
        function generateAdvancedStudyTopics(subject, duration, hoursPerDay) {
            // Generate study topics based on subject with more detail
            const topics = [];
            
            // Sample topics for different subjects with more detail
            const subjectTopics = {
                'Mathematics': [
                    'Algebra Basics: Variables, Equations, and Functions',
                    'Linear Equations: Solving and Graphing',
                    'Quadratic Equations: Factoring and Formula',
                    'Polynomials: Operations and Graphing',
                    'Functions: Domain, Range, and Transformations',
                    'Graphs: Analyzing and Interpreting',
                    'Calculus Intro: Limits and Derivatives',
                    'Derivatives: Rules and Applications',
                    'Integrals: Techniques and Applications',
                    'Applications: Real-world Problems',
                    'Statistics: Descriptive and Inferential',
                    'Probability: Theory and Applications',
                    'Data Analysis: Interpretation and Visualization',
                    'Advanced Topics: Series and Sequences',
                    'Review: Practice Problems and Test Prep',
                    'Final Review: Comprehensive Assessment'
                ],
                'Physics': [
                    'Mechanics: Motion, Forces, and Energy',
                    'Kinematics: Describing Motion',
                    'Dynamics: Forces and Newton\'s Laws',
                    'Work and Energy: Conservation Principles',
                    'Momentum: Collisions and Conservation',
                    'Rotational Motion: Torque and Angular Momentum',
                    'Waves: Properties and Behaviors',
                    'Optics: Light and Vision',
                    'Thermodynamics: Heat and Temperature',
                    'Electricity: Charges and Fields',
                    'Magnetism: Fields and Forces',
                    'Modern Physics: Relativity and Quantum',
                    'Nuclear Physics: Structure and Reactions',
                    'Astrophysics: Stars and Galaxies',
                    'Applied Physics: Practical Applications',
                    'Final Review: Comprehensive Assessment'
                ],
                'History': [
                    'Ancient Civilizations: Mesopotamia and Egypt',
                    'Classical Period: Greece and Rome',
                    'Medieval Times: Feudalism and Religion',
                    'Renaissance: Art, Science, and Exploration',
                    'Age of Exploration: Discoveries and Colonization',
                    'Revolutions: Political and Social Change',
                    'Industrial Age: Technology and Society',
                    'World Wars: Global Conflicts',
                    'Cold War: Ideological Struggle',
                    'Modern Era: Globalization and Technology',
                    'Regional History: Specific Areas and Cultures',
                    'Cultural History: Arts, Literature, and Philosophy',
                    'Economic History: Trade and Development',
                    'Social History: People and Communities',
                    'Final Review: Comprehensive Assessment'
                ]
            };
            
            // Get topics for the subject or use generic ones
            let topicList = subjectTopics[subject] || [
                'Introduction to ' + subject,
                'Fundamental Concepts of ' + subject,
                'Theoretical Frameworks in ' + subject,
                'Practical Applications of ' + subject,
                'Advanced Topics in ' + subject,
                'Case Studies in ' + subject,
                'Current Trends in ' + subject,
                'Research Methods in ' + subject,
                'Ethical Considerations in ' + subject,
                'Interdisciplinary Approaches to ' + subject,
                'Critical Analysis in ' + subject,
                'Problem Solving in ' + subject,
                'Future Directions in ' + subject,
                'Review and Synthesis',
                'Practice and Application',
                'Final Assessment'
            ];
            
            // Generate enough topics for the entire duration
            for (let i = 0; i < duration * 7; i++) {
                topics.push(topicList[i % topicList.length]);
            }
            
            return topics;
        }
        
        function getSubjectTextbooks(subject) {
            const textbooks = {
                'Mathematics': 'Calculus by James Stewart, Linear Algebra Done Right by Sheldon Axler',
                'Physics': 'University Physics by Young and Freedman, Introduction to Quantum Mechanics by David Griffiths',
                'History': 'A People\'s History of the United States by Howard Zinn, The Rise and Fall of the Third Reich by William Shirer',
                'default': 'Recommended textbooks for ' + subject + ' include both introductory and advanced texts'
            };
            
            return textbooks[subject] || textbooks['default'];
        }
        
        function getSubjectCourses(subject) {
            const courses = {
                'Mathematics': 'Coursera: Calculus One, edX: Linear Algebra',
                'Physics': 'Coursera: Introduction to Physics, Khan Academy: Physics',
                'History': 'Coursera: The Modern World, edX: The History of the United States',
                'default': 'Online courses for ' + subject + ' are available on platforms like Coursera, edX, and Khan Academy'
            };
            
            return courses[subject] || courses['default'];
        }
        
        function getSubjectPracticeMaterials(subject) {
            const materials = {
                'Mathematics': 'Problem sets, practice exams, and online problem-solving platforms like Brilliant',
                'Physics': 'Lab simulations, problem sets, and physics problem-solving websites',
                'History': 'Primary source documents, historical timelines, and essay practice prompts',
                'default': 'Practice materials for ' + subject + ' include exercises, projects, and assessment tools'
            };
            
            return materials[subject] || materials['default'];
        }
        
        function downloadStudyPlan() {
            // In a real app, this would generate and download a PDF or text file
            showToast('Study plan downloaded successfully', 'success');
        }

        // --- Location Management ---
        function initializeLocationServices() {
            // Check if location services are enabled
            if (!state.privacy.locationServices) {
                document.getElementById('location-permission-banner').style.display = 'flex';
                return;
            }
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showToast("Geolocation is not supported by your browser", "warning");
                return;
            }
            
            // Check if we already have permission
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(result => {
                    if (result.state === 'granted') {
                        state.locationPermission = true;
                        startLocationTracking();
                    } else if (result.state === 'prompt') {
                        document.getElementById('location-permission-banner').style.display = 'flex';
                    } else {
                        // Permission denied
                        document.getElementById('location-permission-banner').style.display = 'flex';
                    }
                });
            } else {
                // Fallback for browsers that don't support permissions API
                requestLocationPermission();
            }
        }

        function requestLocationPermission() {
            if (!navigator.geolocation) {
                showToast("Geolocation is not supported by your browser", "warning");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    state.locationPermission = true;
                    document.getElementById('location-permission-banner').style.display = 'none';
                    startLocationTracking();
                    showToast("Location access granted", "success");
                },
                error => {
                    console.error("Error getting location:", error);
                    let errorMessage = "Location access denied";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Location access denied by user";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Location information unavailable";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Location request timed out";
                            break;
                    }
                    
                    showToast(errorMessage, "warning");
                    document.getElementById('location-permission-banner').style.display = 'flex';
                }
            );
        }

        function startLocationTracking() {
            if (!state.locationPermission || !navigator.geolocation) return;
            
            // Start watching position
            state.locationWatchId = navigator.geolocation.watchPosition(
                position => {
                    updateCurrentLocation(position.coords.latitude, position.coords.longitude);
                },
                error => {
                    console.error("Error watching position:", error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
            
            // Get initial position
            navigator.geolocation.getCurrentPosition(
                position => {
                    updateCurrentLocation(position.coords.latitude, position.coords.longitude);
                },
                error => {
                    console.error("Error getting initial position:", error);
                }
            );
        }

        function stopLocationTracking() {
            if (state.locationWatchId) {
                navigator.geolocation.clearWatch(state.locationWatchId);
                state.locationWatchId = null;
            }
        }

        function updateCurrentLocation(latitude, longitude) {
            state.currentLocation = {
                latitude,
                longitude,
                timestamp: new Date()
            };
            
            // Check if we're in any of our saved locations
            let inLocation = null;
            for (const location of state.locations) {
                const distance = calculateDistance(
                    latitude, longitude,
                    location.latitude, location.longitude
                );
                
                if (distance <= location.radius) {
                    inLocation = location;
                    break;
                }
            }
            
            // Update current location indicator
            updateLocationIndicator(inLocation);
            
            // Check for location-based automations
            if (inLocation) {
                checkLocationAutomations(inLocation, "enter");
            } else {
                // We're not in any saved location, check for exit automations
                for (const location of state.locations) {
                    if (location.isCurrent) {
                        checkLocationAutomations(location, "exit");
                        break;
                    }
                }
            }
            
            // Update which location is current
            state.locations.forEach(loc => {
                loc.isCurrent = inLocation && loc.id === inLocation.id;
            });
            
            // Update UI
            renderLocationList();
            
            // Update map if initialized
            if (state.map) {
                updateUserLocationMarker(latitude, longitude);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const 1 = lat1 * Math.PI/180;
            const 2 = lat2 * Math.PI/180;
            const  = (lat2-lat1) * Math.PI/180;
            const  = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(/2) * Math.sin(/2) +
                    Math.cos(1) * Math.cos(2) *
                    Math.sin(/2) * Math.sin(/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        function updateLocationIndicator(location) {
            const indicator = document.getElementById('current-location-indicator');
            const text = document.getElementById('current-location-text');
            
            if (location) {
                text.textContent = location.name;
                indicator.style.display = 'flex';
            } else {
                text.textContent = "Unknown Location";
                indicator.style.display = 'flex';
            }
        }

        function switchLocationTab(tabId) {
            // Update tabs
            document.querySelectorAll('.location-tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update content
            document.querySelectorAll('.location-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`location-${tabId}`).classList.add('active');
            
            // Initialize specific tab if needed
            if (tabId === 'locations') {
                renderLocationList();
            } else if (tabId === 'add') {
                initializeMap();
            } else if (tabId === 'automation') {
                renderAutomationRules();
            }
        }

        function renderLocationList() {
            const locationList = document.getElementById('location-list');
            locationList.innerHTML = '';
            
            if (state.locations.length === 0) {
                locationList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No locations saved yet. Add your first location to get started.</p>';
                return;
            }
            
            state.locations.forEach(location => {
                const locationCard = document.createElement('div');
                locationCard.className = `location-card ${location.isCurrent ? 'current' : ''}`;
                
                const distance = state.currentLocation ? 
                    Math.round(calculateDistance(
                        state.currentLocation.latitude, state.currentLocation.longitude,
                        location.latitude, location.longitude
                    )) : null;
                
                locationCard.innerHTML = `
                    <div class="location-card-header">
                        <div class="location-card-name">${location.name}</div>
                        <div class="location-card-type ${location.type}">${location.type}</div>
                    </div>
                    <div class="location-card-coords">
                        <i class="fas fa-map-marker-alt"></i> 
                        ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}
                    </div>
                    <div class="location-card-radius">
                        <i class="fas fa-circle"></i> 
                        ${location.radius}m radius
                    </div>
                    ${distance !== null ? `<div class="location-card-radius">
                        <i class="fas fa-route"></i> 
                        ${distance}m away
                    </div>` : ''}
                    <div class="location-card-actions">
                        <button class="primary-btn" onclick="setCurrentLocation('${location.id}')">
                            <i class="fas fa-crosshairs"></i> Set Current
                        </button>
                        <button class="icon-btn" onclick="deleteLocation('${location.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                locationList.appendChild(locationCard);
            });
        }

        function getCurrentLocation() {
            if (!state.locationPermission) {
                requestLocationPermission();
                return;
            }
            
            if (!navigator.geolocation) {
                showToast("Geolocation is not supported by your browser", "warning");
                return;
            }
            
            showToast("Getting your current location...", "info");
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    
                    // Check if we're already at a saved location
                    let inLocation = null;
                    for (const location of state.locations) {
                        const distance = calculateDistance(latitude, longitude, location.latitude, location.longitude);
                        if (distance <= location.radius) {
                            inLocation = location;
                            break;
                        }
                    }
                    
                    if (inLocation) {
                        showToast(`You're currently at or near ${inLocation.name}`, "success");
                    } else {
                        showToast("You're not at any of your saved locations", "info");
                    }
                    
                    updateCurrentLocation(latitude, longitude);
                },
                error => {
                    console.error("Error getting location:", error);
                    showToast("Failed to get your location", "warning");
                }
            );
        }

        function getCurrentPositionForLocation() {
            if (!state.locationPermission) {
                requestLocationPermission();
                return;
            }
            
            if (!navigator.geolocation) {
                showToast("Geolocation is not supported by your browser", "warning");
                return;
            }
            
            showToast("Getting your current position...", "info");
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    
                    // Create hidden inputs for coordinates if they don't exist
                    if (!document.getElementById('location-latitude')) {
                        const latInput = document.createElement('input');
                        latInput.type = 'hidden';
                        latInput.id = 'location-latitude';
                        document.getElementById('location-add').appendChild(latInput);
                        
                        const lngInput = document.createElement('input');
                        lngInput.type = 'hidden';
                        lngInput.id = 'location-longitude';
                        document.getElementById('location-add').appendChild(lngInput);
                    }
                    
                    // Update the form fields
                    document.getElementById('location-latitude').value = latitude.toFixed(6);
                    document.getElementById('location-longitude').value = longitude.toFixed(6);
                    
                    // Show the geofence indicator
                    const indicator = document.getElementById('geofence-indicator');
                    indicator.style.display = 'flex';
                    
                    // Update map if initialized
                    if (state.map) {
                        updateMapCenter(latitude, longitude);
                        showGeofenceCircle(latitude, longitude, parseInt(document.getElementById('location-radius').value));
                    }
                    
                    showToast("Current position captured", "success");
                },
                error => {
                    console.error("Error getting position:", error);
                    showToast("Failed to get your position", "warning");
                }
            );
        }

        function saveLocation() {
            const name = document.getElementById('location-name').value;
            const type = document.getElementById('location-type').value;
            const radius = parseInt(document.getElementById('location-radius').value);
            
            if (!name) {
                showToast("Please enter a location name", "warning");
                return;
            }
            
            // Get coordinates - either from form or use current position
            let latitude, longitude;
            
            const latInput = document.getElementById('location-latitude');
            const lngInput = document.getElementById('location-longitude');
            
            if (latInput && lngInput && latInput.value && lngInput.value) {
                latitude = parseFloat(latInput.value);
                longitude = parseFloat(lngInput.value);
            } else {
                // Use current position if available
                if (state.currentLocation) {
                    latitude = state.currentLocation.latitude;
                    longitude = state.currentLocation.longitude;
                } else {
                    showToast("Please get your current position first", "warning");
                    return;
                }
            }
            
            // Create new location
            const newLocation = {
                id: `loc-${Date.now()}`,
                name,
                type,
                latitude,
                longitude,
                radius,
                isCurrent: false
            };
            
            // Add to locations
            state.locations.push(newLocation);
            
            // Add marker to map if initialized
            if (state.map) {
                addLocationMarker(newLocation);
            }
            
            // Reset form
            document.getElementById('location-name').value = '';
            document.getElementById('location-type').value = 'home';
            document.getElementById('location-radius').value = '90';
            if (latInput) latInput.value = '';
            if (lngInput) lngInput.value = '';
            
            // Hide geofence indicator
            document.getElementById('geofence-indicator').style.display = 'none';
            
            // Update UI
            renderLocationList();
            
            // Switch to locations tab
            document.querySelectorAll('.location-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.location-tab[onclick="switchLocationTab(\'locations\')"]').classList.add('active');
            
            document.querySelectorAll('.location-content').forEach(content => content.classList.remove('active'));
            document.getElementById('location-locations').classList.add('active');
            
            showToast(`Location "${name}" saved successfully`, "success");
        }

        function setCurrentLocation(locationId) {
            const location = state.locations.find(loc => loc.id === locationId);
            if (!location) return;
            
            // Update current location
            updateCurrentLocation(location.latitude, location.longitude);
            
            // Center map on this location if initialized
            if (state.map) {
                updateMapCenter(location.latitude, location.longitude);
            }
            
            showToast(`Set current location to ${location.name}`, "success");
        }

        function deleteLocation(locationId) {
            if (!confirm("Are you sure you want to delete this location?")) return;
            
            // Find and remove the location
            const index = state.locations.findIndex(loc => loc.id === locationId);
            if (index !== -1) {
                const locationName = state.locations[index].name;
                state.locations.splice(index, 1);
                
                // Remove marker from map if initialized
                if (state.map) {
                    removeLocationMarker(locationId);
                }
                
                // Remove any automation rules for this location
                state.automationRules = state.automationRules.filter(rule => rule.locationId !== locationId);
                
                // Update UI
                renderLocationList();
                renderAutomationRules();
                
                showToast(`Location "${locationName}" deleted`, "success");
            }
        }

        function renderAutomationRules() {
            const rulesContainer = document.getElementById('automation-rules');
            rulesContainer.innerHTML = '';
            
            if (state.automationRules.length === 0) {
                rulesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No automation rules yet. Add your first rule to get started.</p>';
                return;
            }
            
            state.automationRules.forEach(rule => {
                const location = state.locations.find(loc => loc.id === rule.locationId);
                const locationName = location ? location.name : "Unknown Location";
                
                const ruleElement = document.createElement('div');
                ruleElement.className = 'automation-rule';
                ruleElement.innerHTML = `
                    <div class="automation-rule-trigger">
                        When I ${rule.trigger} ${locationName}
                    </div>
                    <div class="automation-rule-action">
                        ${rule.actions.join(', ')}
                    </div>
                    <label class="toggle-switch automation-rule-toggle">
                        <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleAutomationRule('${rule.id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                `;
                
                rulesContainer.appendChild(ruleElement);
            });
        }

        function addAutomationRule() {
            if (state.locations.length === 0) {
                showToast("Please add at least one location first", "warning");
                return;
            }
            
            // Create a simple form for adding a rule
            const formHtml = `
                <div class="card" style="margin-top: 20px;">
                    <h3>Add Automation Rule</h3>
                    <div class="form-group">
                        <label for="rule-location">Location</label>
                        <select id="rule-location">
                            ${state.locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rule-trigger">Trigger</label>
                        <select id="rule-trigger">
                            <option value="enter">When I enter</option>
                            <option value="exit">When I exit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rule-actions">Actions (comma separated)</label>
                        <input type="text" id="rule-actions" placeholder="e.g., Turn on lights, Set temperature to 22C">
                    </div>
                    <div class="form-actions">
                        <button class="primary-btn" onclick="saveAutomationRule()">Save Rule</button>
                        <button class="icon-btn" onclick="this.closest('.card').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Insert the form after the existing rules
            const rulesContainer = document.getElementById('automation-rules');
            rulesContainer.insertAdjacentHTML('afterend', formHtml);
        }

        function saveAutomationRule() {
            const locationId = document.getElementById('rule-location').value;
            const trigger = document.getElementById('rule-trigger').value;
            const actionsText = document.getElementById('rule-actions').value;
            
            if (!actionsText) {
                showToast("Please enter at least one action", "warning");
                return;
            }
            
            const actions = actionsText.split(',').map(action => action.trim());
            
            // Create new rule
            const newRule = {
                id: `rule-${Date.now()}`,
                locationId,
                trigger,
                actions,
                enabled: true
            };
            
            // Add to rules
            state.automationRules.push(newRule);
            
            // Update UI
            renderAutomationRules();
            
            // Remove the form
            const form = document.querySelector('#automation-rules + .card');
            if (form) form.remove();
            
            showToast("Automation rule added successfully", "success");
        }

        function toggleAutomationRule(ruleId, enabled) {
            const rule = state.automationRules.find(r => r.id === ruleId);
            if (rule) {
                rule.enabled = enabled;
                showToast(`Automation rule ${enabled ? 'enabled' : 'disabled'}`, "success");
            }
        }

        function checkLocationAutomations(location, trigger) {
            // Find all rules for this location and trigger
            const rules = state.automationRules.filter(rule => 
                rule.locationId === location.id && 
                rule.trigger === trigger && 
                rule.enabled
            );
            
            // Execute each rule
            rules.forEach(rule => {
                executeAutomationRule(rule, location);
            });
        }

        function executeAutomationRule(rule, location) {
            // In a real implementation, this would execute the actual actions
            // For demo purposes, we'll just show a toast notification
            
            const actionText = rule.actions.join(', ');
            showToast(`Automation triggered: ${actionText}`, "info");
            
            // Add a message to the chat
            const triggerText = rule.trigger === 'enter' ? 'entered' : 'exited';
            addMessage('bot', `I've detected you've ${triggerText} ${location.name}. Executing automation: ${actionText}.`);
            
            // Execute some example actions based on the text
            rule.actions.forEach(action => {
                const lowerAction = action.toLowerCase();
                
                if (lowerAction.includes('turn on') || lowerAction.includes('switch on')) {
                    // Try to turn on a device
                    if (lowerAction.includes('light')) {
                        const lightElement = document.getElementById('dev-light-1');
                        if (lightElement && !state.devices['Light 1']) {
                            toggleDevice('Light 1', lightElement);
                        }
                    }
                } else if (lowerAction.includes('turn off') || lowerAction.includes('switch off')) {
                    // Try to turn off a device
                    if (lowerAction.includes('light')) {
                        const lightElement = document.getElementById('dev-light-1');
                        if (lightElement && state.devices['Light 1']) {
                            toggleDevice('Light 1', lightElement);
                        }
                    }
                } else if (lowerAction.includes('arm security')) {
                    // Arm security system
                    if (!state.devices['Sensor']) {
                        const sensorElement = document.getElementById('dev-sensor');
                        if (sensorElement) {
                            toggleDevice('Sensor', sensorElement);
                        }
                    }
                } else if (lowerAction.includes('disarm security')) {
                    // Disarm security system
                    if (state.devices['Sensor']) {
                        const sensorElement = document.getElementById('dev-sensor');
                        if (sensorElement) {
                            toggleDevice('Sensor', sensorElement);
                        }
                    }
                } else if (lowerAction.includes('temperature')) {
                    // Extract temperature value
                    const tempMatch = lowerAction.match(/(\d+)/);
                    if (tempMatch) {
                        const newTemp = parseInt(tempMatch[1]);
                        const tempDiff = newTemp - state.temperature;
                        
                        if (tempDiff !== 0) {
                            adjustTemperature(tempDiff);
                        }
                    }
                }
            });
        }

        // --- Map Functions ---
        function initializeMap() {
            // Check if map is already initialized
            if (state.map) return;
            
            // Get the map container
            const mapContainer = document.getElementById('geofence-map');
            if (!mapContainer) return;
            
            // Hide the placeholder
            const placeholder = mapContainer.querySelector('.geofence-map-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // Initialize the map centered on Vadlamudi
            state.map = L.map('geofence-map').setView([16.4918, 80.6583], 13);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(state.map);
            
            // Add markers for all saved locations
            state.locations.forEach(location => {
                addLocationMarker(location);
            });
            
            // Add user location marker if available
            if (state.currentLocation) {
                updateUserLocationMarker(state.currentLocation.latitude, state.currentLocation.longitude);
            }
            
            // Add click event to map to capture coordinates
            state.map.on('click', function(e) {
                const { lat, lng } = e.latlng;
                
                // Update form fields if they exist
                const latInput = document.getElementById('location-latitude');
                const lngInput = document.getElementById('location-longitude');
                
                if (latInput && lngInput) {
                    latInput.value = lat.toFixed(6);
                    lngInput.value = lng.toFixed(6);
                    
                    // Show the geofence indicator
                    const indicator = document.getElementById('geofence-indicator');
                    indicator.style.display = 'flex';
                    
                    // Show geofence circle if radius is set
                    const radiusInput = document.getElementById('location-radius');
                    if (radiusInput) {
                        showGeofenceCircle(lat, lng, parseInt(radiusInput.value));
                    }
                    
                    showToast("Location selected on map", "info");
                }
            });
        }
        
        function addLocationMarker(location) {
            if (!state.map) return;
            
            // Create custom icon based on location type
            const iconColors = {
                'home': '#06ffa5',
                'work': '#4361ee',
                'classroom': '#ff006e',
                'other': '#ffbe0b'
            };
            
            const icon = L.divIcon({
                html: `<div style="background-color: ${iconColors[location.type] || iconColors.other}; width: 24px; height: 24px; border-radius: 50%; border: 2px white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12],
                className: 'location-marker'
            });
            
            // Add marker to map
            const marker = L.marker([location.latitude, location.longitude], { icon })
                .addTo(state.map)
                .bindPopup(`<b>${location.name}</b><br>Type: ${location.type}<br>Radius: ${location.radius}m`);
            
            // Add geofence circle
            const circle = L.circle([location.latitude, location.longitude], {
                color: iconColors[location.type] || iconColors.other,
                fillColor: iconColors[location.type] || iconColors.other,
                fillOpacity: 0.2,
                radius: location.radius
            }).addTo(state.map);
            
            // Store marker and circle references
            location.marker = marker;
            location.circle = circle;
            
            // Store in state for later reference
            state.markers.push({ id: location.id, marker, circle });
        }
        
        function removeLocationMarker(locationId) {
            if (!state.map) return;
            
            // Find the marker and circle for this location
            const markerIndex = state.markers.findIndex(m => m.id === locationId);
            if (markerIndex !== -1) {
                const { marker, circle } = state.markers[markerIndex];
                
                // Remove from map
                state.map.removeLayer(marker);
                state.map.removeLayer(circle);
                
                // Remove from state
                state.markers.splice(markerIndex, 1);
            }
        }
        
        function updateUserLocationMarker(latitude, longitude) {
            if (!state.map) return;
            
            // Remove existing user location marker if it exists
            if (state.userLocationMarker) {
                state.map.removeLayer(state.userLocationMarker);
            }
            
            // Create custom icon for user location
            const userIcon = L.divIcon({
                html: `<div style="background-color: #4361ee; width: 16px; height: 16px; border-radius: 50%; border: 3px white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                popupAnchor: [0, -8],
                className: 'user-location-marker'
            });
            
            // Add marker to map
            state.userLocationMarker = L.marker([latitude, longitude], { icon: userIcon })
                .addTo(state.map)
                .bindPopup("Your current location");
        }
        
        function updateMapCenter(latitude, longitude) {
            if (!state.map) return;
            
            // Pan the map to the new center
            state.map.panTo([latitude, longitude]);
        }
        
        function showGeofenceCircle(latitude, longitude, radius) {
            if (!state.map) return;
            
            // Remove existing temporary circle if it exists
            if (state.tempCircle) {
                state.map.removeLayer(state.tempCircle);
            }
            
            // Add new circle
            state.tempCircle = L.circle([latitude, longitude], {
                color: '#4361ee',
                fillColor: '#4361ee',
                fillOpacity: 0.2,
                radius: radius
            }).addTo(state.map);
        }

        // --- Smart Home Functions ---
        function switchRoom(roomId) {
            // Update tabs
            document.querySelectorAll('.room-tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update content
            document.querySelectorAll('.room-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`room-${roomId}`).classList.add('active');
            
            // Update current room
            state.currentRoom = roomId;
        }
        
        function toggleDevice(name, el) {
            state.devices[name] = !state.devices[name];
            if (state.devices[name]) {
                el.classList.add('on');
                const status = el.querySelector('.device-status');
                if (status) {
                    status.classList.remove('off');
                    status.classList.add('on');
                }
                addMessage('bot', `${name} turned ON.`);
            } else {
                el.classList.remove('on');
                const status = el.querySelector('.device-status');
                if (status) {
                    status.classList.remove('on');
                    status.classList.add('off');
                }
                addMessage('bot', `${name} turned OFF.`);
            }
            
            // Update security status if relevant
            if (name === 'Lock') {
                updateSecurityStatus();
            }
            
            // Update smart home widget status
            updateSmartHomeWidgetStatus();
        }
        
        // Function to toggle devices from dashboard
        function toggleDashboardDevice(name, el) {
            // Find the corresponding device in the smart home panel
            let deviceElement = null;
            let deviceId = name.toLowerCase().replace(' ', '-');
            
            // Try to find the device in any room
            for (const [room, devices] of Object.entries(state.rooms)) {
                if (devices.includes(name)) {
                    deviceElement = document.getElementById(`dev-${deviceId}`);
                    if (deviceElement) break;
                }
            }
            
            // If device found, toggle it
            if (deviceElement) {
                toggleDevice(name, deviceElement);
                
                // Update dashboard widget UI
                if (state.devices[name]) {
                    el.classList.add('on');
                    el.querySelector('.smarthome-widget-device-status').textContent = 
                        name === 'Lock' ? 'Locked' : 'On';
                } else {
                    el.classList.remove('on');
                    el.querySelector('.smarthome-widget-device-status').textContent = 
                        name === 'Lock' ? 'Unlocked' : 'Off';
                }
            } else {
                // For devices not in the smart home panel, just toggle state
                state.devices[name] = !state.devices[name];
                
                if (state.devices[name]) {
                    el.classList.add('on');
                    el.querySelector('.smarthome-widget-device-status').textContent = 
                        name === 'Lock' ? 'Locked' : 'On';
                } else {
                    el.classList.remove('on');
                    el.querySelector('.smarthome-widget-device-status').textContent = 
                        name === 'Lock' ? 'Unlocked' : 'Off';
                }
                
                // Update smart home widget status
                updateSmartHomeWidgetStatus();
                
                addMessage('bot', `${name} turned ${state.devices[name] ? 'ON' : 'OFF'}.`);
            }
        }
        
        // Function to update smart home widget status
        function updateSmartHomeWidgetStatus() {
            const statusElement = document.getElementById('smarthome-status');
            if (!statusElement) return;
            
            // Count active devices
            let activeCount = 0;
            for (const [device, isActive] of Object.entries(state.devices)) {
                if (isActive) activeCount++;
            }
            
            statusElement.textContent = `${activeCount} devices active`;
            
            // Update dashboard widget devices
            const dashboardDevices = document.querySelectorAll('.smarthome-widget-device');
            dashboardDevices.forEach(deviceEl => {
                const deviceName = deviceEl.querySelector('.smarthome-widget-device-name').textContent;
                const statusEl = deviceEl.querySelector('.smarthome-widget-device-status');
                
                if (state.devices[deviceName]) {
                    deviceEl.classList.add('on');
                    statusEl.textContent = deviceName === 'Lock' ? 'Locked' : 'On';
                } else {
                    deviceEl.classList.remove('on');
                    statusEl.textContent = deviceName === 'Lock' ? 'Unlocked' : 'Off';
                }
            });
        }
        
        function adjustTemperature(delta) {
            state.temperature += delta;
            document.getElementById('temp-display').textContent = `${state.temperature}C`;
            
            // Turn on AC if temperature is too high
            if (state.temperature > 25 && !state.devices['AC']) {
                const acElement = document.getElementById('dev-ac');
                if (acElement) {
                    toggleDevice('AC', acElement);
                }
            }
            
            // Turn off AC if temperature is low enough
            if (state.temperature <= 22 && state.devices['AC']) {
                const acElement = document.getElementById('dev-ac');
                if (acElement) {
                    toggleDevice('AC', acElement);
                }
            }
        }
        
        function updateSecurityStatus() {
            const statusDiv = document.getElementById('security-status');
            if (!statusDiv) return;
            
            const isLocked = state.devices['Lock'];
            const isArmed = state.devices['Sensor'] || state.devices['Siren'];
            
            if (isLocked && isArmed) {
                statusDiv.className = 'security-status armed';
                statusDiv.innerHTML = `
                    <span style="font-size: 1.5rem;">
                        <i class="fas fa-shield-alt"></i>
                    </span>
                    <div>
                        <div style="font-weight: 500;">Security System</div>
                        <div style="font-size: 0.8rem;">Armed - All sensors active</div>
                    </div>
                `;
            } else if (isLocked && !isArmed) {
                statusDiv.className = 'security-status disarmed';
                statusDiv.innerHTML = `
                    <span style="font-size: 1.5rem;">
                        <i class="fas fa-lock-open"></i>
                    </span>
                    <div>
                        <div style="font-weight: 500;">Security System</div>
                        <div style="font-size: 0.8rem;">Doors locked - Sensors disarmed</div>
                    </div>
                `;
            } else if (!isLocked) {
                statusDiv.className = 'security-status disarmed';
                statusDiv.innerHTML = `
                    <span style="font-size: 1.5rem;">
                        <i class="fas fa-lock-open"></i>
                    </span>
                    <div>
                        <div style="font-weight: 500;">Security System</div>
                        <div style="font-size: 0.8rem;">Doors unlocked - System disarmed</div>
                    </div>
                `;
            }
        }
        
        function executeScene(scene) {
            const scenes = {
                'good-morning': () => {
                    // Turn on lights, open blinds, start coffee maker
                    if (!state.devices['Light 1']) toggleDevice('Light 1', document.getElementById('dev-light-1'));
                    if (!state.devices['Light 2']) toggleDevice('Light 2', document.getElementById('dev-light-2'));
                    if (!state.devices['Light 3']) toggleDevice('Light 3', document.getElementById('dev-light-3'));
                    if (!state.devices['Coffee']) toggleDevice('Coffee', document.getElementById('dev-coffee'));
                    if (state.temperature < 22) adjustTemperature(2);
                    showToast('Good Morning scene activated: Lights on, coffee maker starting, temperature adjusted', 'success');
                },
                'good-night': () => {
                    // Turn off lights, lock doors, set alarm
                    if (state.devices['Light 1']) toggleDevice('Light 1', document.getElementById('dev-light-1'));
                    if (state.devices['Light 2']) toggleDevice('Light 2', document.getElementById('dev-light-2'));
                    if (state.devices['Light 3']) toggleDevice('Light 3', document.getElementById('dev-light-3'));
                    if (!state.devices['Lock']) toggleDevice('Lock', document.getElementById('dev-lock'));
                    if (!state.devices['Alarm']) toggleDevice('Alarm', document.getElementById('dev-alarm'));
                    if (state.temperature > 20) adjustTemperature(-2);
                    showToast('Good Night scene activated: Lights off, doors locked, alarm set, temperature adjusted', 'success');
                },
                'movie-time': () => {
                    // Dim lights, turn on TV and speakers
                    if (!state.devices['TV']) toggleDevice('TV', document.getElementById('dev-tv'));
                    if (!state.devices['Speaker']) toggleDevice('Speaker', document.getElementById('dev-speaker'));
                    if (state.devices['Light 1']) toggleDevice('Light 1', document.getElementById('dev-light-1'));
                    if (state.devices['Light 2']) toggleDevice('Light 2', document.getElementById('dev-light-2'));
                    showToast('Movie Time scene activated: Lights dimmed, TV and speakers on', 'success');
                },
                'away': () => {
                    // Turn off all lights, lock doors, set alarm, turn on cameras
                    for (const device of ["Light 1", "Light 2", "Light 3"]) {
                        if (state.devices[device]) {
                            const deviceElement = document.getElementById(`dev-${device.toLowerCase().replace(' ', '-')}`);
                            if (deviceElement) {
                                toggleDevice(device, deviceElement);
                            }
                        }
                    }
                    if (!state.devices['Lock']) toggleDevice('Lock', document.getElementById('dev-lock'));
                    if (!state.devices['Alarm']) toggleDevice('Alarm', document.getElementById('dev-alarm'));
                    if (!state.devices['Cam']) toggleDevice('Cam', document.getElementById('dev-cam'));
                    if (!state.devices['Sensor']) toggleDevice('Sensor', document.getElementById('dev-sensor'));
                    if (state.temperature > 20) adjustTemperature(-2);
                    showToast('Away Mode activated: All lights off, doors locked, alarm set, cameras on, temperature adjusted', 'success');
                }
            };
            
            if (scenes[scene]) {
                scenes[scene]();
            }
        }

        function toggleHeaderSmarthome() {
            // Switch to smart home panel
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector('.nav-item[onclick="switchTab(\'smarthome\')"]').classList.add('active');
            
            // Update Panels
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.getElementById('panel-smarthome').classList.add('active');
            
            // Update Header Title
            document.getElementById('page-title').innerText = 'Smart Home';
            
            // Close sidebar on mobile
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        // --- Chat Interface ---
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function addMessage(sender, text, sentiment, emotion) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            if (sentiment) div.classList.add(sentiment);
            
            let messageContent = text;
            
            if (emotion && emotion !== 'neutral') {
                const emotionIcon = {
                    'happy': '',
                    'sad': '',
                    'angry': '',
                    'fearful': '',
                    'disgusted': '',
                    'surprised': ''
                };
                
                messageContent += `<span class="emotion-indicator emotion-${emotion}"><span>${emotionIcon[emotion] || ''}</span> ${emotion}</span>`;
            }
            
            // Add message actions for bot messages
            const actionsHtml = sender === 'bot' ? `
                <div class="message-actions">
                    <button onclick="speakMessage(this)" title="Speak">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            ` : '';
            
            div.innerHTML = `${messageContent} <span class="meta">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>${actionsHtml}`;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- Text-to-Speech Function ---
        function speakMessage(button) {
            if (!('speechSynthesis' in window)) {
                showToast("Text-to-speech not supported in this browser", "warning");
                return;
            }
            
            // Get the message text
            const messageElement = button.closest('.message');
            const messageText = messageElement.cloneNode(true);
            
            // Remove the meta and actions elements
            const metaElement = messageText.querySelector('.meta');
            const actionsElement = messageText.querySelector('.message-actions');
            const emotionElement = messageText.querySelector('.emotion-indicator');
            
            if (metaElement) metaElement.remove();
            if (actionsElement) actionsElement.remove();
            if (emotionElement) emotionElement.remove();
            
            const text = messageElement.textContent.trim();
            
            // Create and configure utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            // Find a female voice if available
            const voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice => voice.name.includes('Female') || voice.name.includes('female'));
            if (femaleVoice) {
                utterance.voice = femaleVoice;
            }
            
            // Speak the text
            speechSynthesis.speak(utterance);
            
            // Update button icon to indicate speaking
            const icon = button.querySelector('i');
            icon.className = 'fas fa-stop';
            button.onclick = function() {
                speechSynthesis.cancel();
                icon.className = 'fas fa-volume-up';
                button.onclick = function() { speakMessage(this); };
            };
            
            // Reset button when speaking is done
            utterance.onend = function() {
                icon.className = 'fas fa-volume-up';
                button.onclick = function() { speakMessage(this); };
            };
        }

        // --- Enhanced "Brain" Logic (Simulated AI) ---
        function processAI(input) {
            // Enhanced NLU: Intent detection
            const detectedIntent = detectIntent(input);
            
            // Enhanced entity extraction
            const entities = extractEntities(input, detectedIntent);
            
            // Update context
            updateContext(detectedIntent, entities);
            
            // Generate response based on intent, context, sentiment, and emotion
            return generateResponse(detectedIntent, entities);
        }

        function detectIntent(input) {
            // Simple keyword-based intent detection (in a real app, this would use NLP)
            for (const intent of state.intents) {
                for (const example of intent.examples) {
                    if (input.toLowerCase().includes(example.toLowerCase().substring(0, 5))) {
                        return intent.name;
                    }
                }
            }
            
            // Default intent
            return "general_chat";
        }

        function extractEntities(input, intent) {
            const entities = {};
            
            // Extract entities based on intent
            if (intent === "weather_query") {
                // Extract location
                const locationMatch = input.match(/in ([a-zA-Z\s]+)/);
                if (locationMatch) entities.location = locationMatch[1];
                
                // Extract date
                const dateMatch = input.match(/today|tomorrow|yesterday|next week|next month/);
                if (dateMatch) entities.date = dateMatch[0];
            } else if (intent === "task_management") {
                // Extract task
                const taskMatch = input.match(/(remind me to|add|create|set) (.+)/i);
                if (taskMatch) entities.task = taskMatch[2];
                
                // Extract date/time
                const dateMatch = input.match(/today|tomorrow|at \d+:\d+/);
                if (dateMatch) entities.date = dateMatch[0];
            } else if (intent === "smart_home_control") {
                // Extract device
                const deviceMatch = input.match(/(light|lights|ac|tv|speaker|fan|lock|camera|alarm|sensor|siren|coffee|fridge|dishwasher|humidifier)/i);
                if (deviceMatch) entities.device = deviceMatch[1];
                
                // Extract action
                const actionMatch = input.match(/(turn on|switch on|activate|enable|turn off|switch off|deactivate|disable|dim|brighten|set)/i);
                if (actionMatch) entities.action = actionMatch[1];
                
                // Extract room
                const roomMatch = input.match(/(living room|bedroom|kitchen|security)/i);
                if (roomMatch) entities.room = roomMatch[1];
                
                // Extract value (for temperature, brightness, etc.)
                const valueMatch = input.match(/(\d+)/);
                if (valueMatch) entities.value = valueMatch[1];
            } else if (intent === "scene_control") {
                // Extract scene
                const sceneMatch = input.match(/(good morning|good night|movie time|away mode)/i);
                if (sceneMatch) entities.scene = sceneMatch[1].toLowerCase().replace(' ', '-');
            } else if (intent === "translation_request") {
                // Extract text to translate
                const textMatch = input.match(/translate (.+) to|how do you say (.+) in|what's the word for (.+) in/i);
                if (textMatch) {
                    entities.text = textMatch[1] || textMatch[2] || textMatch[3];
                }
                
                // Extract target language
                const langMatch = input.match(/to (spanish|french|german|chinese|japanese|arabic|hindi|telugu|tamil)/i);
                if (langMatch) entities.language = langMatch[1];
            } else if (intent === "emotion_expression") {
                // Extract emotion
                const emotionMatch = input.match(/(feeling|feel|in a mood) (.+)/i);
                if (emotionMatch) entities.emotion = emotionMatch[2];
                
                // Extract intensity
                const intensityMatch = input.match(/(very|really|so|extremely) (.+)/i);
                if (intensityMatch) entities.intensity = intensityMatch[1];
            } else if (intent === "music_control") {
                // Extract genre, artist, or song
                const genreMatch = input.match(/(rock|pop|jazz|classical|electronic|hip hop|country|blues|reggae)/i);
                if (genreMatch) entities.genre = genreMatch[1];
                
                const artistMatch = input.match(/by ([a-zA-Z\s]+)/i);
                if (artistMatch) entities.artist = artistMatch[1];
                
                const songMatch = input.match(/play (.+) by/i);
                if (songMatch) entities.song = songMatch[1];
            } else if (intent === "time_query") {
                // No specific entities to extract for time queries
            }
            
            return entities;
        }

        function updateContext(intent, entities) {
            // Update context based on intent and entities
            state.context.lastIntent = intent;
            state.context.lastEntities = entities;
            state.context.lastAction = intent;
            
            // Store entities in context for follow-up questions
            if (entities.location) state.context.location = entities.location;
            if (entities.date) state.context.date = entities.date;
            if (entities.emotion) state.context.emotion = entities.emotion;
            if (entities.room) state.context.room = entities.room;
        }

        function generateResponse(intent, entities) {
            // Find response template for this intent
            const responseTemplate = state.responses.find(r => r.intent === intent);
            
            if (responseTemplate) {
                // Replace entity placeholders with actual values
                let response = responseTemplate.text;
                
                for (const [key, value] of Object.entries(entities)) {
                    const placeholder = `{${key}}`;
                    response = response.replace(new RegExp(placeholder, 'g'), value || 'unknown');
                }
                
                // Handle missing entities
                response = response.replace(/{\w+}/g, 'unknown');
                
                return response;
            }
            
            // Fallback responses based on intent
            switch (intent) {
                case "weather_query":
                    const location = entities.location || "Vadlamudi";
                    const date = entities.date || "today";
                    return `It's currently 22C and sunny in ${location} ${date}. Perfect weather for a walk!`;
                    
                case "task_management":
                    const task = entities.task || "your task";
                    const taskDate = entities.date || "today";
                    addTask(task);
                    return `I've added "${task}" to your task list for ${taskDate}.`;
                    
                case "information_lookup":
                    return "I can help with information. What would you like to know?";
                    
                case "smart_home_control":
                    const device = entities.device || "device";
                    const action = entities.action || "control";
                    const room = entities.room || "the room";
                    
                    // Execute the smart home command
                    if (action && device) {
                        // Find the device in the current room or specified room
                        const targetRoom = entities.room || state.currentRoom;
                        const roomDevices = state.rooms[targetRoom.replace(' ', '-')];
                        
                        if (roomDevices) {
                            // Find matching device
                            const matchingDevice = roomDevices.find(d => 
                                d.toLowerCase().includes(device.toLowerCase())
                            );
                            
                            if (matchingDevice) {
                                // Toggle the device
                                const deviceElement = document.getElementById(`dev-${matchingDevice.toLowerCase().replace(' ', '-')}`);
                                if (deviceElement) {
                                    if (action.includes('off') || action.includes('disable') || action.includes('deactivate')) {
                                        if (state.devices[matchingDevice]) {
                                            toggleDevice(matchingDevice, deviceElement);
                                        }
                                    } else if (action.includes('on') || action.includes('enable') || action.includes('activate')) {
                                        if (!state.devices[matchingDevice]) {
                                            toggleDevice(matchingDevice, deviceElement);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    return `I'll ${action} the ${device} in the ${room}.`;
                    
                case "scene_control":
                    const scene = entities.scene;
                    if (scene) {
                        executeScene(scene);
                        return `Activating ${scene.replace('-', ' ')} scene now.`;
                    }
                    return "Which scene would you like to activate?";
                    
                case "translation_request":
                    const textToTranslate = entities.text;
                    const targetLanguage = entities.language;
                    
                    if (textToTranslate && targetLanguage) {
                        // Switch to translation tab
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                        document.querySelector('.nav-item[onclick="switchTab(\'translate\')"]').classList.add('active');
                        
                        // Update Panels
                        document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
                        document.getElementById('panel-translate').classList.add('active');
                        
                        // Update Header Title
                        document.getElementById('page-title').innerText = 'Language Translator';
                        
                        // Set source text and target language
                        document.getElementById('source-text').value = textToTranslate;
                        const langMap = {
                            'spanish': 'es',
                            'french': 'fr',
                            'german': 'de',
                            'chinese': 'zh',
                            'japanese': 'ja',
                            'arabic': 'ar',
                            'hindi': 'hi',
                            'telugu': 'te',
                            'tamil': 'ta'
                        };
                        
                        const langCode = langMap[targetLanguage.toLowerCase()] || 'es';
                        document.getElementById('target-lang').value = langCode;
                        
                        // Auto-translate
                        translateText();
                        
                        return `Translating "${textToTranslate}" to ${targetLanguage}...`;
                    }
                    
                    return "What would you like me to translate and to which language?";
                    
                case "document_analysis":
                    const analysisType = entities.analysis_type || "analyze";
                    
                    // Switch to document tab
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.querySelector('.nav-item[onclick="switchTab(\'docs\')"]').classList.add('active');
                    
                    // Update Panels
                    document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
                    document.getElementById('panel-docs').classList.add('active');
                    
                    // Update Header Title
                    document.getElementById('page-title').innerText = 'Document AI';
                    
                    return `I can help with ${analysisType}. Please paste your text or upload a document.`;
                    
                case "emotion_expression":
                    const detectedEmotion = entities.emotion || "neutral";
                    return `I understand you're feeling ${detectedEmotion}. ${getEmotionResponse(detectedEmotion, entities.intensity)}`;
                    
                case "music_control":
                    const genre = entities.genre || "your favorite";
                    const artist = entities.artist || "";
                    const song = entities.song || "";
                    
                    // Switch to music tab
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.querySelector('.nav-item[onclick="switchTab(\'music\')"]').classList.add('active');
                    
                    // Update Panels
                    document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
                    document.getElementById('panel-music').classList.add('active');
                    
                    // Update Header Title
                    document.getElementById('page-title').innerText = 'Music & Podcasts';
                    
                    // Start playing music
                    if (!state.isPlaying) {
                        togglePlayPause();
                    }
                    
                    if (artist) {
                        return `Playing music by ${artist}. Enjoy!`;
                    } else if (song) {
                        return `Playing "${song}". Enjoy!`;
                    } else {
                        return `Playing ${genre} music for you. Enjoy!`;
                    }
                    
                case "time_query":
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    const dayString = now.toLocaleDateString('en-US', { 
                        weekday: 'long' 
                    });
                    const dateString = now.toLocaleDateString('en-US', { 
                        month: 'long', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                    
                    return `The current time is ${timeString} on ${dayString}, ${dateString}.`;
                    
                case "general_chat":
                    // Context-aware responses
                    if (state.context.lastIntent === "weather_query" && (input.includes("what about") || input.includes("how about"))) {
                        const location = state.context.location || "Vadlamudi";
                        return `Tomorrow in ${location} will be 24C with partly cloudy skies.`;
                    }
                    
                    // Emotion-aware responses
                    if (state.context.emotion === "happy") {
                        return "I'm glad to hear you're feeling happy! Is there anything special you'd like to do today?";
                    } else if (state.context.emotion === "sad") {
                        return "I'm sorry to hear you're feeling sad. Would you like to talk about what's bothering you, or would you prefer a distraction?";
                    } else if (state.context.emotion === "angry") {
                        return "I understand you're feeling angry. Taking a few deep breaths might help. Is there something I can assist with to address the issue?";
                    } else if (state.context.emotion === "fearful") {
                        return "It sounds like you're feeling anxious. Remember that it's okay to feel this way. Would you like some calming music or a breathing exercise?";
                    }
                    
                    // Sentiment-aware responses
                    if (analyzeSentiment(input) === "negative") {
                        return "I'm sorry to hear that. Is there anything I can do to help?";
                    } else if (analyzeSentiment(input) === "positive") {
                        return "That's great to hear! How else can I assist you today?";
                    }
                    
                    // Personalized responses based on user preferences
                    if (state.privacy.personalizedResponses && state.userPreferences && state.userPreferences.favoriteTopics) {
                        for (const topic of state.userPreferences.favoriteTopics) {
                            if (input.toLowerCase().includes(topic.toLowerCase())) {
                                return `I know you're interested in ${topic}! Here's what I can tell you about it...`;
                            }
                        }
                    }
                    
                    // Default fallback
                    const fallbacks = [
                        "That's interesting. Tell me more.",
                        "I can help with tasks, smart home, documents, calendar, email, music, fitness, or translation. What do you need?",
                        "I'm listening.",
                        `How does that relate to your ${state.mode} goals?`
                    ];
                    return fallbacks[Math.floor(Math.random() * fallbacks.length)];
                    
                default:
                    return "I'm not sure how to respond to that. Can you try rephrasing?";
            }
        }

        function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // Analyze sentiment and emotion
            const sentiment = analyzeSentiment(text);
            const emotion = detectEmotion(text);
            
            // Update current emotion
            if (emotion !== 'neutral') {
                state.currentEmotion = emotion;
            }
            
            // Add user message with sentiment and emotion
            addMessage('user', text, sentiment, emotion);
            userInput.value = '';
            
            // Process Intent
            showTyping(true);
            
            // Simulate AI processing delay
            setTimeout(() => {
                const response = processAI(text);
                showTyping(false);
                addMessage('bot', response);
            }, 1000 + Math.random() * 1000);
        }

        function showTyping(show) {
            document.getElementById('typing-indicator').style.display = show ? 'flex' : 'none';
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- Enhanced Sentiment Analysis ---
        function analyzeSentiment(text) {
            const negativeWords = ['stressed', 'sad', 'bad', 'angry', 'hate', 'tired', 'pain', 'anxious', 'frustrated', 'upset', 'worried'];
            const positiveWords = ['happy', 'good', 'great', 'love', 'excited', 'thanks', 'awesome', 'fantastic', 'wonderful', 'amazing', 'pleased'];
            
            const words = text.toLowerCase().match(/\w+/g) || [];
            let score = 0;
            
            words.forEach(w => {
                if (negativeWords.includes(w)) score--;
                if (positiveWords.includes(w)) score++;
            });

            if (score < 0) return 'negative';
            if (score > 0) return 'positive';
            return 'neutral';
        }

        // --- Enhanced Emotion Detection ---
        function detectEmotion(text) {
            const emotionKeywords = {
                happy: ['happy', 'joy', 'excited', 'delighted', 'pleased', 'glad', 'cheerful', 'content', 'satisfied'],
                sad: ['sad', 'unhappy', 'down', 'blue', 'depressed', 'melancholy', 'gloomy', 'miserable'],
                angry: ['angry', 'mad', 'furious', 'irritated', 'annoyed', 'frustrated', 'enraged', 'outraged'],
                fearful: ['afraid', 'scared', 'fearful', 'anxious', 'worried', 'nervous', 'terrified', 'panicked'],
                disgusted: ['disgusted', 'revolted', 'repulsed', 'sickened', 'nauseated'],
                surprised: ['surprised', 'amazed', 'astonished', 'shocked', 'stunned', 'bewildered']
            };
            
            const words = text.toLowerCase().match(/\w+/g) || [];
            let emotionScores = {};
            
            // Calculate scores for each emotion
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                emotionScores[emotion] = 0;
                for (const word of words) {
                    if (keywords.includes(word)) {
                        emotionScores[emotion]++;
                    }
                }
            }
            
            // Find the emotion with the highest score
            let maxScore = 0;
            let detectedEmotion = 'neutral';
            
            for (const [emotion, score] of Object.entries(emotionScores)) {
                if (score > maxScore) {
                    maxScore = score;
                    detectedEmotion = emotion;
                }
            }
            
            // Return neutral if no emotion detected
            return maxScore > 0 ? detectedEmotion : 'neutral';
        }

        function getEmotionResponse(emotion, intensity) {
            const responses = {
                happy: {
                    low: "It's wonderful to feel happy! What's bringing you joy today?",
                    medium: "I'm so glad you're feeling happy! Happiness is contagious!",
                    high: "That's amazing! Your positive energy is wonderful to see!"
                },
                sad: {
                    low: "I'm sorry you're feeling a bit down. Sometimes talking about it can help.",
                    medium: "I understand you're feeling sad. Remember that it's okay to feel this way, and it will pass.",
                    high: "I'm really sorry you're feeling so sad. Would you like some resources that might help?"
                },
                angry: {
                    low: "I understand you're feeling a bit frustrated. Taking a moment to breathe might help.",
                    medium: "It sounds like you're quite angry. Your feelings are valid, and finding a healthy outlet is important.",
                    high: "I can see you're very angry right now. Consider taking a break before addressing what's bothering you."
                },
                fearful: {
                    low: "I understand you're feeling a bit anxious. Deep breathing exercises might help.",
                    medium: "It sounds like you're quite worried. Remember that anxiety is a normal response to stress.",
                    high: "I can see you're feeling very fearful. Talking to someone you trust might help ease these feelings."
                },
                disgusted: {
                    low: "I understand you're feeling a bit disgusted. Sometimes removing yourself from the situation helps.",
                    medium: "It sounds like something really bothered you. Your reaction is completely valid.",
                    high: "I can see you're feeling very disgusted. Taking time to process these feelings is important."
                },
                surprised: {
                    low: "I understand you're a bit surprised. Sometimes the unexpected can be jarring.",
                    medium: "It sounds like you were quite surprised! What caught you off guard?",
                    high: "Wow, you must be really shocked! I'd be interested to hear more about what happened."
                }
            };
            
            const intensityLevel = intensity === 'very' || intensity === 'extremely' ? 'high' : 
                                   intensity === 'really' || intensity === 'so' ? 'medium' : 'low';
            
            return responses[emotion] ? responses[emotion][intensityLevel] || responses[emotion].low : "";
        }

        // --- Task Management ---
        function addTask(text) {
            const taskText = text || document.getElementById('new-task-input').value;
            if (!taskText) return;
            
            const task = { id: Date.now(), text: taskText, completed: false };
            state.tasks.push(task);
            renderTasks();
            if(!text) document.getElementById('new-task-input').value = '';
            if(text) showToast("Task added", "success");
        }

        function toggleTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
            }
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            renderTasks();
        }

        function renderTasks() {
            const list = document.getElementById('task-list-ui');
            list.innerHTML = '';
            state.tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `task-item ${task.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})">
                        <span>${task.text}</span>
                    </div>
                    <div class="task-actions">
                        <button onclick="deleteTask(${task.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // --- Calendar Functions ---
        function renderCalendar() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            const firstDay = new Date(state.currentYear, state.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === state.currentYear && today.getMonth() === state.currentMonth;
            const todayDate = today.getDate();
            
            document.getElementById('calendar-month-year').textContent = `${monthNames[state.currentMonth]} ${state.currentYear}`;
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                if (isCurrentMonth && day === todayDate) {
                    dayElement.classList.add('today');
                }
                
                // Check for events on this day
                const currentDate = new Date(state.currentYear, state.currentMonth, day);
                const hasEvent = state.calendarEvents.some(event => 
                    event.date.getDate() === day && 
                    event.date.getMonth() === state.currentMonth && 
                    event.date.getFullYear() === state.currentYear
                );
                
                if (hasEvent) {
                    const event = state.calendarEvents.find(event => 
                        event.date.getDate() === day && 
                        event.date.getMonth() === state.currentMonth && 
                        event.date.getFullYear() === state.currentYear
                    );
                    
                    if (event.type === 'holiday') {
                        dayElement.classList.add('holiday');
                    } else {
                        dayElement.classList.add('has-event');
                    }
                }
                
                dayElement.addEventListener('click', () => {
                    const events = state.calendarEvents.filter(event => 
                        event.date.getDate() === day && 
                        event.date.getMonth() === state.currentMonth && 
                        event.date.getFullYear() === state.currentYear
                    );
                    
                    if (events.length > 0) {
                        const eventTitles = events.map(e => e.title).join(', ');
                        showToast(`${monthNames[state.currentMonth]} ${day}, ${state.currentYear}: ${eventTitles}`, 'info');
                    } else {
                        showToast(`Selected: ${monthNames[state.currentMonth]} ${day}, ${state.currentYear}`, 'info');
                    }
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Update events list
            updateEventsList();
        }
        
        function updateEventsList() {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            // Get events for the current month
            const currentMonthEvents = state.calendarEvents.filter(event => 
                event.date.getMonth() === state.currentMonth && 
                event.date.getFullYear() === state.currentYear
            );
            
            // Sort events by date
            currentMonthEvents.sort((a, b) => a.date - b.date);
            
            // Add upcoming events
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingEvents = currentMonthEvents.filter(event => event.date >= today);
            
            if (upcomingEvents.length === 0) {
                eventsList.innerHTML = '<p style="color: var(--text-secondary);">No upcoming events this month.</p>';
                return;
            }
            
            upcomingEvents.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = `event-item ${event.type}`;
                
                const eventDate = event.date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                eventItem.innerHTML = `
                    <div><strong>${event.title}</strong></div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${eventDate}</div>
                `;
                
                eventsList.appendChild(eventItem);
            });
        }
        
        function changeMonth(direction) {
            state.currentMonth += direction;
            
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            } else if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            
            renderCalendar();
        }

        // --- Email Functions ---
        function openEmail(id) {
            const email = state.emails.find(e => e.id === id);
            if (!email) return;
            
            document.getElementById('email-detail-subject').textContent = email.subject;
            document.getElementById('email-detail-content').textContent = email.content;
            document.getElementById('email-detail').style.display = 'block';
            
            // Mark as read
            email.read = true;
            document.querySelectorAll('.email-item').forEach((item, index) => {
                if (index === id - 1) {
                    item.classList.remove('unread');
                }
            });
        }
        
        function generateReply() {
            showToast("Generating AI-powered reply suggestions...", "info");
            setTimeout(() => {
                showToast("Reply suggestions ready! (This would show suggested replies in a real implementation)", "success");
            }, 1500);
        }

        // --- Music Functions ---
        function togglePlayPause() {
            state.isPlaying = !state.isPlaying;
            document.getElementById('play-pause-btn').innerHTML = state.isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        }
        
        function playTrack(track, artist) {
            document.getElementById('track-name').textContent = track;
            document.getElementById('artist-name').textContent = artist;
            
            // Update playlist UI
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.classList.remove('playing');
            });
            event.currentTarget.classList.add('playing');
            
            // Start playing
            if (!state.isPlaying) {
                togglePlayPause();
            }
        }

        // --- Fitness Functions ---
        function startWorkout(type) {
            const workoutTypes = {
                'cardio': 'Starting 30-minute cardio workout...',
                'strength': 'Starting strength training session...',
                'yoga': 'Starting 20-minute yoga session...',
                'meditation': 'Starting 10-minute guided meditation...'
            };
            
            showToast(workoutTypes[type], 'success');
        }

        // --- Document Assistant ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('doc-content').value = e.target.result;
                    showToast("File loaded successfully", "success");
                };
                reader.readAsText(file);
            }
        }

        function analyzeDocument() {
            const text = document.getElementById('doc-content').value;
            if (!text) return showToast("Please enter text first", "warning");

            const resultsDiv = document.getElementById('analysis-results');
            const contentDiv = document.getElementById('analysis-content');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = "Analyzing...";

            // Simulate Analysis
            setTimeout(() => {
                const words = text.split(/\s+/).length;
                const sentences = text.split(/[.!?]+/).length;
                const firstSentence = text.split(/[.!?]/)[0];
                
                contentDiv.innerHTML = `
                    <strong>Word Count:</strong> ${words}<br>
                    <strong>Sentence Count:</strong> ${sentences}<br><br>
                    <strong>Key Points:</strong> ${firstSentence}...
                `;
            }, 800);
        }
        
        function clearDoc() {
            document.getElementById('doc-content').value = '';
            document.getElementById('analysis-results').style.display = 'none';
        }

        // --- Admin Dashboard Functions ---
        function initializeAdmin() {
            // Initialize analytics values
            document.getElementById('total-conversations').textContent = state.analytics.totalConversations.toLocaleString();
            document.getElementById('unique-users').textContent = state.analytics.uniqueUsers;
            document.getElementById('avg-response-time').textContent = state.analytics.avgResponseTime + 's';
            document.getElementById('success-rate').textContent = state.analytics.successRate + '%';
        }

        // --- Utilities ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--accent)';
            toast.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getNewTip() {
            const tips = [
                "Drink water every 30 minutes.",
                "Use the Pomodoro technique: 25m work, 5m break.",
                "Stretch your legs every hour.",
                "Clear your desktop to clear your mind.",
                "Write down 3 goals for tomorrow.",
                "Take a 5-minute meditation break.",
                "Try the 2-minute rule: if it takes less than 2 minutes, do it now.",
                "Schedule your most important tasks for your peak energy hours."
            ];
            document.getElementById('tip-text').innerText = `"${tips[Math.floor(Math.random() * tips.length)]}"`;
        }

        // Initialize
        window.onload = () => {
            // Set greeting based on time
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Morning" : hour < 18 ? "Afternoon" : "Evening";
            document.getElementById('time-of-day').innerText = greeting;
            
            // Initialize analytics values
            document.getElementById('total-conversations').textContent = state.analytics.totalConversations.toLocaleString();
            document.getElementById('unique-users').textContent = state.analytics.uniqueUsers;
            document.getElementById('avg-response-time').textContent = state.analytics.avgResponseTime + 's';
            document.getElementById('success-rate').textContent = state.analytics.successRate + '%';
            
            // Check for saved privacy settings
            const savedPrivacy = localStorage.getItem('aidaPrivacySettings');
            if (savedPrivacy) {
                try {
                    state.privacy = JSON.parse(savedPrivacy);
                    document.getElementById('save-history').checked = state.privacy.saveHistory;
                    document.getElementById('voice-data').checked = state.privacy.useVoiceData;
                    document.getElementById('personalized-responses').checked = state.privacy.personalizedResponses;
                    document.getElementById('proactive-suggestions').checked = state.privacy.proactiveSuggestions;
                    document.getElementById('location-services').checked = state.privacy.locationServices;
                } catch (error) {
                    console.error("Error loading privacy settings:", error);
                }
            }
            
            // Initialize security status
            updateSecurityStatus();
            
            // Initialize calendar with current date
            renderCalendar();
            
            // Update smart home widget status
            updateSmartHomeWidgetStatus();
            
            // Load voices for text-to-speech
            if ('speechSynthesis' in window) {
                // Load voices
                speechSynthesis.getVoices();
                
                // Chrome loads voices asynchronously
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => {
                        // Voices are loaded
                    };
                }
            }
            
            // Initialize admin dashboard
            initializeAdmin();
            
            // Show current location
            updateLocationIndicator(state.locations[0]);
            
            // Initialize map when switching to smart home tab
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.onclick && item.onclick.toString().includes('smarthome')) {
                    item.addEventListener('click', () => {
                        setTimeout(() => {
                            if (document.getElementById('panel-smarthome').classList.contains('active')) {
                                initializeMap();
                            }
                        }, 100);
                    });
                }
            });
        };

        // Save privacy settings when changed
        document.addEventListener('change', (e) => {
            if (e.target.id === 'save-history') {
                state.privacy.saveHistory = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'voice-data') {
                state.privacy.useVoiceData = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'personalized-responses') {
                state.privacy.personalizedResponses = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'proactive-suggestions') {
                state.privacy.proactiveSuggestions = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'location-services') {
                state.privacy.locationServices = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
                
                if (e.target.checked) {
                    initializeLocationServices();
                } else {
                    stopLocationTracking();
                    document.getElementById('location-permission-banner').style.display = 'flex';
                }
            } else if (e.target.id === 'admin-save-history') {
                state.privacy.saveHistory = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'admin-voice-data') {
                state.privacy.useVoiceData = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'admin-personalized') {
                state.privacy.personalizedResponses = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'admin-anonymous-data') {
                state.privacy.shareAnonymousData = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'admin-proactive-suggestions') {
                state.privacy.proactiveSuggestions = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
            } else if (e.target.id === 'admin-location-services') {
                state.privacy.locationServices = e.target.checked;
                localStorage.setItem('aidaPrivacySettings', JSON.stringify(state.privacy));
                
                if (e.target.checked) {
                    initializeLocationServices();
                } else {
                    stopLocationTracking();
                }
            }
        });

        // --- Translation Functions - Enhanced ---
        async function translateText() {
            const sourceText = document.getElementById('source-text').value;
            if (!sourceText) {
                showToast('Please enter text to translate', 'warning');
                return;
            }
            
            const sourceLang = document.getElementById('source-lang').value;
            const targetLang = document.getElementById('target-lang').value;
            
            // Show loading state
            document.getElementById('translated-text').value = 'Translating...';
            
            try {
                // Use a more reliable translation API
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(sourceText)}&langpair=${sourceLang}|${targetLang}`);
                const data = await response.json();
                
                if (data.responseStatus === 200) {
                    document.getElementById('translated-text').value = data.responseData.translatedText;
                    showToast('Translation complete!', 'success');
                    
                    // Add to conversation history
                    addConversationTranslation(sourceText, data.responseData.translatedText, sourceLang, targetLang);
                } else {
                    throw new Error(data.responseDetails || 'Translation failed');
                }
            } catch (error) {
                console.error('Translation error:', error);
                
                // Improved fallback translation with more comprehensive dictionary
                const fallbackTranslations = {
                    'en-es': {
                        'hello': 'hola',
                        'thank you': 'gracias',
                        'goodbye': 'adis',
                        'please': 'por favor',
                        'yes': 's',
                        'no': 'no',
                        'water': 'agua',
                        'food': 'comida',
                        'help': 'ayuda',
                        'friend': 'amigo',
                        'morning': 'maana',
                        'evening': 'noche',
                        'today': 'hoy',
                        'how are you': 'cmo ests',
                        'what is your name': 'cmo te llamas',
                        'where is the bathroom': 'dnde est el bao',
                        'i love you': 'te quiero',
                        'good morning': 'buenos das',
                        'good night': 'buenas noches',
                        'see you later': 'hasta luego'
                    },
                    'es-en': {
                        'hola': 'hello',
                        'gracias': 'thank you',
                        'adis': 'goodbye',
                        'por favor': 'please',
                        's': 'yes',
                        'no': 'no',
                        'agua': 'water',
                        'comida': 'food',
                        'ayuda': 'help',
                        'amigo': 'friend',
                        'maana': 'morning',
                        'noche': 'evening',
                        'hoy': 'today',
                        'cmo ests': 'how are you',
                        'cmo te llamas': 'what is your name',
                        'dnde est el bao': 'where is the bathroom',
                        'te quiero': 'i love you',
                        'buenos das': 'good morning',
                        'buenas noches': 'good night',
                        'hasta luego': 'see you later'
                    },
                    'en-fr': {
                        'hello': 'bonjour',
                        'thank you': 'merci',
                        'goodbye': 'au revoir',
                        'please': 's\'il vous plat',
                        'yes': 'oui',
                        'no': 'non',
                        'water': 'eau',
                        'food': 'nourriture',
                        'help': 'aide',
                        'friend': 'ami'
                    },
                    'fr-en': {
                        'bonjour': 'hello',
                        'merci': 'thank you',
                        'au revoir': 'goodbye',
                        's\'il vous plat': 'please',
                        'oui': 'yes',
                        'non': 'no',
                        'eau': 'water',
                        'nourriture': 'food',
                        'aide': 'help',
                        'ami': 'friend'
                    },
                    'en-de': {
                        'hello': 'hallo',
                        'thank you': 'danke',
                        'goodbye': 'auf wiedersehen',
                        'please': 'bitte',
                        'yes': 'ja',
                        'no': 'nein',
                        'water': 'wasser',
                        'food': 'essen',
                        'help': 'hilfe',
                        'friend': 'freund'
                    },
                    'de-en': {
                        'hallo': 'hello',
                        'danke': 'thank you',
                        'auf wiedersehen': 'goodbye',
                        'bitte': 'please',
                        'ja': 'yes',
                        'nein': 'no',
                        'wasser': 'water',
                        'essen': 'food',
                        'hilfe': 'help',
                        'freund': 'friend'
                    },
                    'en-zh': {
                        'hello': '',
                        'thank you': '',
                        'goodbye': '',
                        'please': '',
                        'yes': '',
                        'no': '',
                        'water': '',
                        'food': '',
                        'help': ''
                    },
                    'zh-en': {
                        '': 'hello',
                        '': 'thank you',
                        '': 'goodbye',
                        '': 'please',
                        '': 'yes',
                        '': 'no',
                        '': 'water',
                        '': 'food',
                        '': 'help'
                    },
                    'en-ja': {
                        'hello': '',
                        'thank you': '',
                        'goodbye': '',
                        'please': '',
                        'yes': '',
                        'no': '',
                        'water': '',
                        'food': '',
                        'help': ''
                    },
                    'ja-en': {
                        '': 'hello',
                        '': 'thank you',
                        '': 'goodbye',
                        '': 'please',
                        '': 'yes',
                        '': 'no',
                        '': 'water',
                        '': 'food',
                        '': 'help'
                    },
                    'en-ar': {
                        'hello': '',
                        'thank you': '',
                        'goodbye': '',
                        'please': ' ',
                        'yes': '',
                        'no': '',
                        'water': '',
                        'food': ''
                    },
                    'ar-en': {
                        '': 'hello',
                        '': 'thank you',
                        '': 'goodbye',
                        ' ': 'please',
                        '': 'yes',
                        '': 'no',
                        '': 'water',
                        '': 'food'
                    },
                    'en-hi': {
                        'hello': '',
                        'thank you': '',
                        'goodbye': '',
                        'please': '',
                        'yes': '',
                        'no': '',
                        'water': ''
                    },
                    'hi-en': {
                        '': 'hello',
                        '': 'thank you',
                        '': 'goodbye',
                        '': 'please',
                        '': 'yes',
                        '': 'no',
                        '': 'water'
                    },
                    'en-te': {
                        'hello': '',
                        'thank you': '',
                        'goodbye': '',
                        'please': '',
                        'yes': '',
                        'no': '',
                        'water': ''
                    },
                    'te-en': {
                        '': 'hello',
                        '': 'thank you',
                        '': 'goodbye',
                        '': 'please',
                        '': 'yes',
                        '': 'no',
                        '': 'water'
                    },
                    'en-ta': {
                        'hello': '',
                        'thank you': '',
                        'goodbye': '',
                        'please': ' ',
                        'yes': '',
                        'no': '',
                        'water': '',
                        'food': ''
                    },
                    'ta-en': {
                        '': 'hello',
                        '': 'thank you',
                        '': 'goodbye',
                        ' ': 'please',
                        '': 'yes',
                        '': 'no',
                        '': 'water',
                        '': 'food'
                    }
                };
                
                const langPair = `${sourceLang}-${targetLang}`;
                const translations = fallbackTranslations[langPair] || {};
                
                // Try to find a direct translation
                let translatedText = translations[sourceText.toLowerCase()] || 
                                  translations[sourceText.toLowerCase().split(' ')[0]] || 
                                  `[Translation from ${getLanguageName(sourceLang)} to ${getLanguageName(targetLang)}]: ${sourceText}`;
                
                document.getElementById('translated-text').value = translatedText;
                showToast('Translation complete (using fallback dictionary)', 'info');
            }
        }
        
        function addConversationTranslation(original, translated, sourceLang, targetLang) {
            const conversationHistory = document.getElementById('conversation-history');
            const conversationItem = document.createElement('div');
            conversationItem.className = 'conversation-item';
            conversationItem.innerHTML = `
                <div class="conversation-original">${original}</div>
                <div class="conversation-translated">${translated}</div>
            `;
            conversationHistory.appendChild(conversationItem);
            
            // Keep only last 5 translations in the UI
            while (conversationHistory.children.length > 5) {
                conversationHistory.removeChild(conversationHistory.firstChild);
            }
        }
        
        function translatePhrase(phrase) {
            document.getElementById('source-text').value = phrase;
            translateText();
        }
        
        function swapLanguages() {
            const sourceLang = document.getElementById('source-lang').value;
            const targetLang = document.getElementById('target-lang').value;
            const sourceText = document.getElementById('source-text').value;
            const translatedText = document.getElementById('translated-text').value;
            
            document.getElementById('source-lang').value = targetLang;
            document.getElementById('target-lang').value = sourceLang;
            document.getElementById('source-text').value = translatedText;
            document.getElementById('translated-text').value = sourceText;
        }
        
        function copyTranslation() {
            const translatedText = document.getElementById('translated-text').value;
            if (!translatedText) {
                showToast('No translation to copy', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(translatedText).then(() => {
                showToast('Translation copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy translation', 'warning');
            });
        }
        
        function speakTranslation() {
            const translatedText = document.getElementById('translated-text').value;
            if (!translatedText) {
                showToast('No translation to speak', 'warning');
                return;
            }
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(translatedText);
                const targetLang = document.getElementById('target-lang').value;
                
                // Set language for speech synthesis if supported
                const langMap = {
                    'en': 'en-US',
                    'es': 'es-ES',
                    'fr': 'fr-FR',
                    'de': 'de-DE',
                    'zh': 'zh-CN',
                    'ja': 'ja-JP',
                    'ar': 'ar-SA',
                    'hi': 'hi-IN',
                    'te': 'te-IN',
                    'ta': 'ta-IN'
                };
                
                utterance.lang = langMap[targetLang] || 'en-US';
                speechSynthesis.speak(utterance);
                showToast('Speaking translation...', 'info');
            } else {
                showToast('Text-to-speech not supported in this browser', 'warning');
            }
        }
        
        function getLanguageName(code) {
            const languages = {
                'en': 'English',
                'es': 'Spanish',
                'fr': 'French',
                'de': 'German',
                'zh': 'Chinese',
                'ja': 'Japanese',
                'ar': 'Arabic',
                'hi': 'Hindi',
                'te': 'Telugu',
                'ta': 'Tamil'
            };
            return languages[code] || code;
        }

        // --- Voice Control ---
        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return showToast("Voice API not supported in this browser", "warning");
            }

            if (state.isListening) {
                // Stop
                state.recognition.stop();
                state.isListening = false;
                document.getElementById('voice-indicator').classList.remove('active');
            } else {
                // Start
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                state.recognition = new SpeechRecognition();
                state.recognition.continuous = false;
                state.recognition.lang = 'en-US';
                state.recognition.interimResults = false;

                state.recognition.onstart = () => {
                    state.isListening = true;
                    document.getElementById('voice-indicator').classList.add('active');
                    showToast("Listening...", "info");
                };

                state.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('user-input').value = transcript;
                    setTimeout(sendMessage, 500); // Auto send
                };

                state.recognition.onend = () => {
                    state.isListening = false;
                    document.getElementById('voice-indicator').classList.remove('active');
                };
                
                state.recognition.onerror = (event) => {
                    showToast("Voice error: " + event.error, "warning");
                    state.isListening = false;
                    document.getElementById('voice-indicator').classList.remove('active');
                };

                state.recognition.start();
            }
        }

        // --- Voice Translation ---
        function toggleVoiceTranslation() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return showToast("Voice API not supported in this browser", "warning");
            }

            const icon = document.getElementById('voice-translation-icon');
            const text = document.getElementById('voice-translation-text');

            if (state.isListening) {
                // Stop
                state.recognition.stop();
                state.isListening = false;
                icon.className = 'fas fa-microphone';
                text.textContent = 'Start Voice Translation';
            } else {
                // Start
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                state.recognition = new SpeechRecognition();
                state.recognition.continuous = false;
                state.recognition.interimResults = false;

                // Detect language based on source language selection
                const sourceLang = document.getElementById('source-lang').value;
                const langMap = {
                    'en': 'en-US',
                    'es': 'es-ES',
                    'fr': 'fr-FR',
                    'de': 'de-DE',
                    'zh': 'zh-CN',
                    'ja': 'ja-JP',
                    'ar': 'ar-SA',
                    'hi': 'hi-IN',
                    'te': 'te-IN',
                    'ta': 'ta-IN'
                };
                
                state.recognition.lang = langMap[sourceLang] || 'en-US';

                state.recognition.onstart = () => {
                    state.isListening = true;
                    icon.className = 'fas fa-stop';
                    text.textContent = 'Stop Voice Translation';
                    showToast("Listening for speech to translate...", "info");
                };

                state.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('source-text').value = transcript;
                    
                    // Auto-translate
                    translateText();
                    
                    // Reset UI
                    icon.className = 'fas fa-microphone';
                    text.textContent = 'Start Voice Translation';
                    state.isListening = false;
                };

                state.recognition.onend = () => {
                    if (state.isListening) {
                        icon.className = 'fas fa-microphone';
                        text.textContent = 'Start Voice Translation';
                        state.isListening = false;
                    }
                };
                
                state.recognition.onerror = (event) => {
                    showToast("Voice error: " + event.error, "warning");
                    icon.className = 'fas fa-microphone';
                    text.textContent = 'Start Voice Translation';
                    state.isListening = false;
                };

                state.recognition.start();
            }
        }

    </script>
</body>
</html>
